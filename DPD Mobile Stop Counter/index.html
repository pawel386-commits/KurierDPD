<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kurier Log - DPD Edition</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kurier Log">
    
    <!-- Kolor paska systemowego i Notcha -->
    <meta name="theme-color" content="#dc0032">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dpd: { red: '#dc0032', dark: '#2d2d2d', gray: '#f4f4f4' }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --dpd-red: #dc0032;
        }
        
        /* Kluczowe dla iPhone: tło html musi być czerwone dla góry, 
           aby notch nie miał białych pasków przy odbiciu scrolla */
        html {
            background-color: var(--dpd-red);
        }

        body { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            margin: 0;
            padding: 0;
            background-color: #f4f4f4; /* Domyślne tło body (jasne) */
        }

        .dark body {
            background-color: #000000; /* Tło body (ciemne) */
        }
        
        /* Obszar nagłówka rozciągnięty pod Notch */
        .header-safe-area {
            padding-top: env(safe-area-inset-top);
            background-color: var(--dpd-red);
            width: 100%;
        }

        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .pulse-red { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 0, 50, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0); }
        }
        
        #map { height: 100%; width: 100%; z-index: 1; }
        .view-hidden { display: none !important; }
        .map-dark-filter { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        input[type="radio"]:checked + label {
            border-color: #dc0032;
            background-color: rgba(220, 0, 50, 0.05);
            color: #dc0032;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-dpd-dark dark:text-gray-100 min-h-screen flex flex-col overflow-hidden text-left transition-colors duration-300">

    <!-- Header z pełnym wypełnieniem Notcha -->
    <header class="bg-dpd-red text-white shadow-lg z-20 w-full flex-none">
        <div class="header-safe-area"></div>
        
        <div class="p-4 pt-2 pb-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white px-2 py-1.5 rounded-lg inline-block shadow-sm">
                        <img src="https://www.dpd.com/wp-content/themes/DPD_NoLogin/images/DPD_logo_redgrad_rgb_responsive.svg" 
                             alt="DPD Logo" class="h-5 w-auto">
                    </div>
                    <div>
                        <p id="headerName" class="text-[10px] font-black uppercase tracking-wider leading-tight">Licznik Stopów</p>
                        <p id="headerSubtitle" class="text-[8px] font-bold opacity-75 uppercase tracking-[0.2em]">DPD Logistics</p>
                    </div>
                </div>
                <div id="headerActions" class="text-right flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <div id="wakeStatus" class="inline-flex items-center gap-1 text-[8px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10 shrink-0">
                            <div id="wakeDot" class="w-1.5 h-1.5 bg-red-500 rounded-full"></div> <span id="wakeText">Blokada: Wył</span>
                        </div>
                        <div id="currentDate" class="text-[10px] font-bold opacity-90 tracking-wider whitespace-nowrap">--.--.----</div>
                    </div>

                    <div class="flex gap-2">
                        <button id="viewToggle" onclick="handleMapToggle()" class="inline-flex items-center gap-2 text-[10px] font-bold bg-white text-dpd-red px-3 py-1.5 rounded-full uppercase shadow-md active:scale-95 transition-all">
                            <i data-lucide="map" id="toggleIcon" class="w-3.5 h-3.5"></i> <span id="toggleText">Mapa</span>
                        </button>
                        <button onclick="cycleThemeManual()" class="bg-black/20 p-1.5 rounded-full border border-white/10 active:scale-90 transition-all flex items-center justify-center">
                            <i id="themeQuickIcon" data-lucide="sun" class="w-4 h-4 text-white"></i>
                        </button>
                        <button onclick="toggleView('settings')" class="bg-black/20 p-1.5 rounded-full border border-white/10 active:scale-90 transition-all">
                            <i data-lucide="settings" class="w-4 h-4 text-white"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-white/10 rounded-xl p-3 flex justify-between items-center border border-white/10">
                <span class="text-xs font-bold uppercase opacity-80">Suma dzisiaj:</span>
                <div class="flex items-baseline gap-1">
                    <span id="stopCounter" class="text-3xl font-black">0</span>
                    <span class="text-[10px] font-bold opacity-60">STOP</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Hack dla podtrzymania ekranu: Niewidoczne wideo 1x1 piksel -->
    <video id="noSleepVideo" playsinline muted loop style="position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none;">
        <source src="https://raw.githubusercontent.com/anars/blank-audio/master/10-seconds-of-silence.mp4" type="video/mp4">
    </video>

    <main class="flex-1 relative overflow-hidden bg-gray-100 dark:bg-zinc-900 text-left">
        <!-- List View -->
        <div id="listView" class="absolute inset-0 p-4 overflow-y-auto z-1 transition-opacity">
            <div id="livePreview" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700/50 rounded-xl text-sm italic text-gray-600 dark:text-yellow-200 hidden min-h-[40px] flex items-center gap-2 shadow-sm">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                </span>
                <span id="liveText">Słucham...</span>
            </div>

            <div id="emptyState" class="text-center py-20 text-gray-400 hidden">
                <i data-lucide="mic" class="w-16 h-16 mx-auto mb-4 opacity-10"></i>
                <p class="font-medium text-sm">Brak zapisanych stopów.</p>
                <p id="emptyInstruction" class="text-[10px]">Kliknij mikrofon i dyktuj.</p>
            </div>

            <ul id="addressList" class="space-y-3 pb-64"></ul>
        </div>

        <div id="mapView" class="absolute inset-0 z-0 view-hidden">
            <div id="map"></div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 p-6 overflow-y-auto view-hidden pb-40">
            <div style="height: env(safe-area-inset-top);"></div>
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-6 h-6 text-dpd-red"></i>
                    <h2 class="text-xl font-black uppercase tracking-tight">Ustawienia</h2>
                </div>
                <button onclick="toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-8">
                <section>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-3 ml-1">Personalizacja</label>
                    <div class="space-y-4">
                        <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 focus-within:border-dpd-red transition-colors text-left">
                             <label class="text-[10px] font-bold text-gray-500 block mb-1">Twoje Imię</label>
                             <input type="text" id="setCourierName" placeholder="Np. Jan Kowalski" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 text-left">
                        </div>
                        <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 focus-within:border-dpd-red transition-colors text-left">
                            <label class="text-[10px] font-bold text-gray-500 block mb-1">Słowo wyzwalające notatkę</label>
                            <input type="text" id="setStopWord" placeholder="Np. notatka" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 text-left">
                        </div>
                    </div>
                </section>

                <section>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-3 ml-1">Wygląd</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="relative">
                            <input type="radio" name="themeMode" id="themeLight" value="light" class="hidden" onchange="applySettings()">
                            <label for="themeLight" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-transparent bg-gray-50 dark:bg-zinc-900 text-[10px] font-bold uppercase transition-all">
                                <i data-lucide="sun" class="w-4 h-4"></i> Jasny
                            </label>
                        </div>
                        <div class="relative">
                            <input type="radio" name="themeMode" id="themeDark" value="dark" class="hidden" onchange="applySettings()">
                            <label for="themeDark" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-transparent bg-gray-50 dark:bg-zinc-900 text-[10px] font-bold uppercase transition-all">
                                <i data-lucide="moon" class="w-4 h-4"></i> Ciemny
                            </label>
                        </div>
                        <div class="relative">
                            <input type="radio" name="themeMode" id="themeAuto" value="auto" class="hidden" onchange="applySettings()">
                            <label for="themeAuto" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-transparent bg-gray-50 dark:bg-zinc-900 text-[10px] font-bold uppercase transition-all">
                                <i data-lucide="sunrise" class="w-4 h-4"></i> Auto
                            </label>
                        </div>
                    </div>
                </section>

                <section>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-3 ml-1">System</label>
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <div class="flex items-center gap-3">
                            <i data-lucide="navigation" class="w-5 h-5 text-gray-400"></i>
                            <span class="text-sm font-bold">Zapisuj pozycję GPS</span>
                        </div>
                        <input type="checkbox" id="setGpsEnabled" onchange="applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                </section>

                <section class="pt-4 border-t border-gray-100 dark:border-zinc-800">
                    <button onclick="shareApp()" class="w-full bg-dpd-dark dark:bg-zinc-800 text-white p-4 rounded-2xl font-black uppercase text-xs flex items-center justify-center gap-3 shadow-lg active:scale-95 transition-all">
                        <i data-lucide="share-2" class="w-4 h-4"></i> Udostępnij aplikację
                    </button>
                    <p class="text-center text-[9px] font-bold opacity-30 uppercase tracking-[0.3em] mt-8">Wersja 7.0 • DPD Licznik Stopów</p>
                </section>
            </div>
        </div>
    </main>

    <!-- Bottom Bar -->
    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 z-30 transition-transform duration-300">
        <div class="h-12 bg-gradient-to-t from-gray-100 dark:from-black to-transparent"></div>
        <div class="bg-gray-100 dark:bg-black safe-bottom px-6 pb-6">
            <div class="max-w-md mx-auto flex justify-around items-center bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl border border-gray-200 dark:border-zinc-800 p-4 relative">
                <button onclick="clearData()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-red">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase">Reset</span>
                </button>
                <div class="relative -top-8 text-center">
                    <button id="micBtn" onclick="toggleRecognition()" class="bg-dpd-red text-white w-20 h-20 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all border-4 border-white dark:border-zinc-900">
                        <i data-lucide="mic" id="micIcon" class="w-10 h-10"></i>
                    </button>
                    <div id="micLabel" class="text-[10px] font-bold text-dpd-red mt-1 opacity-0 transition-opacity uppercase font-black">Nagrywam</div>
                </div>
                <button onclick="exportToCSV()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-dark">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase">Excel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-dpd-dark text-white px-6 py-3 rounded-xl text-sm font-bold shadow-xl opacity-0 transition-all pointer-events-none z-[60] flex items-center gap-2">
        <i data-lucide="info" id="toastIcon" class="w-4 h-4 text-dpd-red"></i>
        <span id="toastText"></span>
    </div>

    <script>
        // --- DATA & CONFIG ---
        let addresses = JSON.parse(localStorage.getItem('dpd_logs_v7') || '[]');
        let config = JSON.parse(localStorage.getItem('dpd_config_v3') || JSON.stringify({
            name: "",
            stopWord: "notatka",
            theme: "auto", 
            gpsEnabled: true
        }));

        let isRecording = false;
        let wakeLock = null;
        let currentTranscript = "";
        let currentView = 'list';
        let map = null;
        let markersGroup = null;

        lucide.createIcons();

        // --- SUNRISE / SUNSET ---
        function getSunTimes(lat = 52.23, lng = 21.01) {
            const date = new Date();
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const offset = (Math.sin((dayOfYear - 80) / 365 * 2 * Math.PI) * 2.5); 
            return { sunrise: 6 - offset, sunset: 18 + offset };
        }

        function refreshTheme(showNotify = false) {
            let targetTheme = config.theme;
            if (config.theme === 'auto') {
                const now = new Date();
                const currentHour = now.getHours() + now.getMinutes() / 60;
                const times = getSunTimes();
                targetTheme = (currentHour >= times.sunrise && currentHour < times.sunset) ? 'light' : 'dark';
            }
            if (targetTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeQuickIcon').setAttribute('data-lucide', 'moon');
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeQuickIcon').setAttribute('data-lucide', 'sun');
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#dc0032');
            }
            lucide.createIcons();
            if (showNotify) showToast(`Motyw: ${targetTheme === 'dark' ? 'Nocny' : 'Jasny'}`, "palette", "text-blue-400");
        }

        function cycleThemeManual() {
            if (config.theme === 'light') config.theme = 'dark';
            else if (config.theme === 'dark') config.theme = 'auto';
            else config.theme = 'light';
            saveConfig();
            initSettingsUI();
            refreshTheme(true);
        }

        // --- WAKE LOCK ENGINE ---
        const video = document.getElementById('noSleepVideo');

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
        }

        async function toggleWakeLock(force = true) {
            const dot = document.getElementById('wakeDot');
            const text = document.getElementById('wakeText');
            if (force) {
                // Metoda 1: Native API
                await requestWakeLock();
                // Metoda 2: Video Hack (dla iOS)
                video.play().catch(() => {});
                
                if (dot) dot.classList.replace('bg-red-500', 'bg-green-500');
                if (text) text.textContent = 'Blokada: WŁ';
            }
        }

        // Re-acquire wake lock when tab becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // --- SETTINGS UI ---
        function initSettingsUI() {
            document.getElementById('setCourierName').value = config.name;
            document.getElementById('setStopWord').value = config.stopWord;
            document.getElementById('setGpsEnabled').checked = config.gpsEnabled;
            if (config.theme === 'light') document.getElementById('themeLight').checked = true;
            if (config.theme === 'dark') document.getElementById('themeDark').checked = true;
            if (config.theme === 'auto') document.getElementById('themeAuto').checked = true;

            document.getElementById('setCourierName').addEventListener('input', applySettings);
            document.getElementById('setStopWord').addEventListener('input', applySettings);
        }

        function applySettings() {
            config.name = document.getElementById('setCourierName').value;
            config.stopWord = document.getElementById('setStopWord').value.toLowerCase().trim() || "notatka";
            config.gpsEnabled = document.getElementById('setGpsEnabled').checked;
            const radio = document.querySelector('input[name="themeMode"]:checked');
            if (radio) config.theme = radio.value;
            saveConfig();
            document.getElementById('headerName').textContent = config.name ? `Kurier: ${config.name}` : "Licznik Stopów";
            document.getElementById('emptyInstruction').innerHTML = `Powiedz adres, a potem słowo "${config.stopWord}",<br>aby dodać uwagi do doręczenia.`;
            refreshTheme();
        }

        function saveConfig() { localStorage.setItem('dpd_config_v3', JSON.stringify(config)); }

        // --- VIEW MANAGEMENT ---
        function handleMapToggle() { currentView === 'map' ? toggleView('list') : toggleView('map'); }
        function toggleView(view) {
            const lv = document.getElementById('listView'), mv = document.getElementById('mapView'), sv = document.getElementById('settingsView'), bb = document.getElementById('bottomBar'), ha = document.getElementById('headerActions');
            [lv, mv, sv].forEach(el => el.classList.add('view-hidden'));
            bb.classList.remove('translate-y-40');
            ha.classList.remove('opacity-0', 'pointer-events-none');
            if (view === 'map') {
                mv.classList.remove('view-hidden');
                document.getElementById('toggleText').textContent = 'Lista';
                document.getElementById('toggleIcon').setAttribute('data-lucide', 'list');
                currentView = 'map'; initMap();
                setTimeout(() => { map.invalidateSize(); renderMarkers(); }, 100);
            } else if (view === 'settings') {
                sv.classList.remove('view-hidden');
                bb.classList.add('translate-y-40');
                ha.classList.add('opacity-0', 'pointer-events-none');
                currentView = 'settings';
            } else {
                lv.classList.remove('view-hidden');
                document.getElementById('toggleText').textContent = 'Mapa';
                document.getElementById('toggleIcon').setAttribute('data-lucide', 'map');
                currentView = 'list'; saveAndRender();
            }
            lucide.createIcons();
        }

        // --- MAP ENGINE ---
        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([52.23, 21.01], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
            markersGroup = L.layerGroup().addTo(map);
            refreshTheme();
        }

        function renderMarkers() {
            if (!markersGroup) return;
            markersGroup.clearLayers();
            const validPoints = addresses.filter(a => a.lat && a.lng);
            if (validPoints.length === 0) return;
            const bounds = L.latLngBounds();
            validPoints.forEach(p => {
                const marker = L.circleMarker([p.lat, p.lng], {
                    radius: 8, fillColor: "#dc0032", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
                }).addTo(markersGroup);
                marker.bindPopup(`<b>${p.time}</b><br>${p.address}${p.note ? '<br><i style="color:gray;">'+p.note+'</i>' : ''}`);
                bounds.extend([p.lat, p.lng]);
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // --- SPEECH LOGIC ---
        function formatPolishNumbers(text) {
            let t = text.toLowerCase().trim();
            t = t.replace(/(\w+)\s+naście/g, '$1naście').replace(/(\w+)\s+dzieści/g, '$1dzieści').replace(/(\w+)\s+dziesiąt/g, '$1dziesiąt');
            const numMap = { 'zero': '0', 'jeden': '1', 'dwa': '2', 'trzy': '3', 'cztery': '4', 'pięć': '5', 'sześć': '6', 'siedem': '7', 'osiem': '8', 'dziewięć': '9', 'dziesięć': '10', 'jedenaście': '11', 'dwanaście': '12', 'trzynaście': '13', 'czternaście': '14', 'piętnaście': '15', 'szesnaście': '16', 'siedemnaście': '17', 'osiemnaście': '18', 'dziewiętnaście': '19', 'dwadzieścia': '20', 'trzydzieści': '30', 'czterdzieści': '40', 'pięćdziesiąt': '50', 'sześćdziesiąt': '60', 'siedemdziesiąt': '70', 'osiemdziesiąt': '80', 'dziewięćdziesiąt': '90', 'sto': '100' };
            Object.keys(numMap).forEach(word => { t = t.replace(new RegExp(`\\b${word}\\b`, 'g'), numMap[word]); });
            t = t.replace(/\b(20|30|40|50|60|70|80|90)\s+([1-9])\b/g, (m, p1, p2) => parseInt(p1) + parseInt(p2));
            t = t.replace(/(\d+[a-z]?)\s*(przez|łamane przez|łamane na|mieszkania|lokalu|mieszkanie)\s*(\d+[a-z]?)/g, '$1/$3');
            t = t.replace(/(\d+)\s+([a-z])\b/g, '$1$2').replace(/([0-9a-z]+)\s*\/\s*([0-9a-z]+)/gi, '$1/$2');
            return t;
        }

        function splitAddressAndNote(rawText) {
            const word = ` ${config.stopWord} `;
            const index = rawText.toLowerCase().indexOf(word);
            return index !== -1 ? { address: formatPolishNumbers(rawText.substring(0, index).trim()), note: rawText.substring(index + word.length).trim() } : { address: formatPolishNumbers(rawText), note: "" };
        }

        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition(); recognition.lang = 'pl-PL'; recognition.interimResults = true; 
            recognition.onstart = () => { isRecording = true; document.getElementById('micBtn').classList.add('pulse-red'); document.getElementById('micIcon').setAttribute('data-lucide', 'circle-stop'); document.getElementById('livePreview').classList.remove('hidden'); document.getElementById('micLabel').style.opacity = '1'; lucide.createIcons(); toggleWakeLock(true); };
            recognition.onresult = (e) => { let interim = ''; for (let i = e.resultIndex; i < e.results.length; ++i) { if (e.results[i].isFinal) { addEntry(e.results[i][0].transcript); recognition.stop(); } else { interim = e.results[i][0].transcript; } } document.getElementById('liveText').textContent = interim || "Słucham..."; };
            recognition.onend = () => stopUIRecording();
        }
        function stopUIRecording() { isRecording = false; document.getElementById('micBtn').classList.remove('pulse-red'); document.getElementById('micIcon').setAttribute('data-lucide', 'mic'); document.getElementById('livePreview').classList.add('hidden'); document.getElementById('micLabel').style.opacity = '0'; lucide.createIcons(); }
        function toggleRecognition() { recognition && (isRecording ? recognition.stop() : recognition.start()); }

        function addEntry(text) {
            if (!text || text.trim().length < 2) return;
            const data = splitAddressAndNote(text);
            const address = data.address.charAt(0).toUpperCase() + data.address.slice(1);
            const note = data.note ? data.note.charAt(0).toUpperCase() + data.note.slice(1) : "";
            if (config.gpsEnabled && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => saveEntry(address, note, p.coords.latitude, p.coords.longitude), () => saveEntry(address, note, null, null), { timeout: 5000 });
            } else saveEntry(address, note, null, null);
        }

        function saveEntry(address, note, lat, lng) {
            addresses.unshift({ id: Date.now(), time: new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }), date: new Date().toLocaleDateString('pl-PL'), address, note, lat, lng });
            saveAndRender(); showToast("Stop zapisany!", "check-circle", "text-green-400");
        }

        function saveAndRender() {
            localStorage.setItem('dpd_logs_v7', JSON.stringify(addresses));
            document.getElementById('stopCounter').textContent = addresses.length;
            const listEl = document.getElementById('addressList'), emptyEl = document.getElementById('emptyState');
            if (addresses.length === 0) { listEl.innerHTML = ''; emptyEl.classList.remove('hidden'); return; }
            emptyEl.classList.add('hidden');
            listEl.innerHTML = addresses.map(item => `
                <li class="bg-white dark:bg-zinc-800 p-4 rounded-2xl shadow-sm border-l-4 border-l-dpd-red border border-gray-100 dark:border-zinc-700 flex flex-col gap-2">
                    <div class="flex justify-between items-start text-left">
                        <div class="flex-1 pr-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-black bg-dpd-dark dark:bg-zinc-950 text-white px-2 py-0.5 rounded italic">DPD ${item.time}</span>
                                ${item.lat ? '<i data-lucide="map-pin" class="w-3 h-3 text-blue-500"></i>' : ''}
                            </div>
                            <p class="text-dpd-dark dark:text-gray-100 font-bold text-sm mt-1 leading-tight">${item.address}</p>
                        </div>
                        <button onclick="deleteAddress(${item.id})" class="text-gray-300 dark:text-zinc-600 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                    ${item.note ? `<div class="bg-gray-50 dark:bg-zinc-900/50 p-2 rounded-lg flex items-start gap-2 border border-gray-100 dark:border-zinc-800 text-left">
                        <i data-lucide="info" class="w-3.5 h-3.5 text-gray-400 mt-0.5"></i>
                        <p class="text-[11px] text-gray-500 dark:text-zinc-400 italic leading-snug">${item.note}</p>
                    </div>` : ''}
                </li>
            `).join('');
            lucide.createIcons(); if (currentView === 'map') renderMarkers();
        }

        function deleteAddress(id) { if (confirm("Usunąć stop?")) { addresses = addresses.filter(a => a.id !== id); saveAndRender(); } }
        function clearData() { if (confirm("Wyczyścić dzisiejszą listę?")) { addresses = []; saveAndRender(); showToast("Wyczyszczono", "check", "text-blue-400"); } }
        function exportToCSV() {
            if (addresses.length === 0) return showToast("Brak danych");
            let csv = "\uFEFFData;Godzina;Adres;Notatka;Szerokość;Długość\n" + addresses.map(r => `${r.date};${r.time};"${r.address}";"${r.note || ''}";${r.lat || ''};${r.lng || ''}`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Raport_DPD_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        }

        function showToast(msg, icon = "info", color = "text-blue-400") {
            const t = document.getElementById('toast'); document.getElementById('toastText').textContent = msg;
            const iconEl = document.getElementById('toastIcon'); iconEl.setAttribute('data-lucide', icon); iconEl.className = `w-4 h-4 ${color}`;
            lucide.createIcons(); t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2500);
        }

        function shareApp() { navigator.share ? navigator.share({ title: 'DPD Licznik Stopów', text: 'Polecam!', url: window.location.href }) : showToast("Skopiuj link z paska", "copy"); }

        document.body.addEventListener('click', () => toggleWakeLock(true), { once: true });
        initSettingsUI(); refreshTheme(); saveAndRender();
        setInterval(() => { const now = new Date(); document.getElementById('currentDate').textContent = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' }); if (config.theme === 'auto') refreshTheme(); }, 60000);
    </script>
</body>
</html>