<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kurier Log - DPD AI Edition</title>
    
    <!-- iPhone Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta id="theme-color-meta" name="theme-color" content="#dc0032">
    <meta name="apple-mobile-web-app-title" content="DPD Log AI">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23dc0032'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'>DPD</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dpd: { red: '#dc0032', dark: '#2d2d2d', gray: '#f4f4f4', ai: '#8b5cf6' }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --dpd-red: #dc0032; }
        html { background-color: var(--dpd-red); transition: background-color 0.3s ease; }
        html.dark { background-color: #000000; }
        body { -webkit-tap-highlight-color: transparent; user-select: text; margin: 0; padding: 0; background-color: #f4f4f4; height: 100%; }
        /* Pozwól na zaznaczanie tekstu, ale nie na przyciskach */
        button, .no-select { user-select: none; }
        .dark body { background-color: #000000; }
        .header-safe-area { padding-top: env(safe-area-inset-top); background-color: var(--dpd-red); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .pulse-red { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 0, 50, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0); }
        }

        .pulse-ai { animation: pulse-ai 1s infinite; background-color: #8b5cf6 !important; }
        @keyframes pulse-ai {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(139, 92, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        #map { height: 100%; width: 100%; z-index: 1; }
        .view-hidden { display: none !important; }
        ::-webkit-scrollbar { display: none; }
        .modal-active { opacity: 1 !important; pointer-events: auto !important; }
        .modal-active > div { transform: scale(1) !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .glass-card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, select, textarea { font-size: 16px !important; }
        
        /* Border colors for dark mode */
        .dark .border-dpd-red { border-color: #dc0032 !important; }
        .dark .border-zinc-500 { border-color: #71717a !important; }
        
        /* Cross-platform improvements */
        @media (hover: hover) {
            /* Desktop - pokaż hover effects */
            button:hover { opacity: 0.8; }
        }
        
        @media (hover: none) {
            /* Mobile - większe targety dotykowe */
            button { min-height: 44px; min-width: 44px; }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            input, textarea { 
                -webkit-appearance: none;
                appearance: none;
                border-radius: 0;
            }
        }

        /* Marker Badge Styling */
        .marker-pin-wrapper { position: relative; width: 32px; height: 32px; }
        .marker-badge { 
            position: absolute; top: -5px; right: -5px; 
            background: #000; color: #fff; 
            font-size: 10px; font-weight: 900; 
            width: 16px; height: 16px; 
            border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; 
            border: 2px solid #fff; z-index: 10;
        }
    </style>
</head>
<body class="text-dpd-dark dark:text-gray-100 flex flex-col h-full overflow-hidden text-left transition-colors duration-300">

    <!-- Nagłówek -->
    <header class="bg-dpd-red text-white shadow-lg z-20 w-full flex-none">
        <div class="header-safe-area"></div>
        <div class="p-4 pt-2 pb-4 text-left">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white px-2 py-1.5 rounded-lg inline-block shadow-sm">
                        <img src="https://www.dpd.com/wp-content/themes/DPD_NoLogin/images/DPD_logo_redgrad_rgb_responsive.svg" alt="DPD Logo" class="h-5 w-auto">
                    </div>
                    <div>
                        <p id="headerName" class="text-xs font-black uppercase tracking-wider leading-tight text-left">Kurier Log AI</p>
                        <p id="headerSubtitle" class="text-[10px] font-bold opacity-75 uppercase tracking-[0.2em] text-left">DPD Logistics</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2 text-right">
                    <div class="flex items-center gap-1.5 justify-end">
                        <div id="aiStatusBox" class="inline-flex items-center gap-1 text-[10px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10 shrink-0">
                            <div id="aiDot" class="w-1.5 h-1.5 bg-green-500 rounded-full transition-colors"></div> 
                            <span id="aiStatusLabel">AI: OK</span>
                        </div>
                        <div id="wakeStatusBox" class="inline-flex items-center gap-1 text-[10px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10 shrink-0">
                            <div id="wakeDot" class="w-1.5 h-1.5 bg-red-500 rounded-full transition-colors"></div> <span id="wakeText">Blokada: Wył</span>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center justify-end">
                        <button id="toggleBtn" onclick="window.handleMapToggle()" class="inline-flex items-center gap-2 text-xs font-bold bg-white text-dpd-red px-3 py-1.5 h-9 rounded-full uppercase shadow-md active:scale-95 transition-all">
                            <i data-lucide="map" id="toggleIcon" class="w-3.5 h-3.5"></i> <span id="toggleText">Mapa</span>
                        </button>
                        <button onclick="window.cycleThemeManual()" class="bg-black/20 w-9 h-9 flex flex-col items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                            <i id="themeQuickIcon" data-lucide="sun" class="w-4 h-4 text-white"></i>
                            <span id="themeAutoLabel" class="text-[8px] font-black uppercase mt-0.5 hidden leading-none">Auto</span>
                        </button>
                        <button onclick="window.toggleView('settings')" class="bg-black/20 w-10 h-10 flex items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                            <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Doręczenia</span>
                    <span id="deliveryCounter" class="text-xl font-black leading-none">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Odbiory</span>
                    <span id="pickupCounter" class="text-xl font-black leading-none text-zinc-300">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Napiwki</span>
                    <span id="tipTotal" class="text-xl font-black leading-none text-green-300">0.00 zł</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-gray-100 dark:bg-zinc-900 text-left">
        <!-- Widok Listy -->
        <div id="listView" class="absolute inset-0 p-4 overflow-y-auto z-1">
            <div id="livePreview" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700/50 rounded-xl text-sm italic text-gray-600 dark:text-yellow-200 hidden min-h-[40px] flex items-center gap-2 shadow-sm">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                </span>
                <span id="liveText" class="break-words">Słucham...</span>
            </div>
            <div id="emptyState" class="text-center py-20 text-gray-400 hidden">
                <i data-lucide="mic" class="w-16 h-16 mx-auto mb-4 opacity-10"></i>
                <p class="font-medium text-sm">Podyktuj adres (np. "Polna 5").</p>
            </div>
            <ul id="addressList" class="space-y-3 pb-64 text-left"></ul>
        </div>

        <!-- Widok Mapy -->
        <div id="mapView" class="absolute inset-0 z-0 view-hidden">
            <div id="map"></div>
        </div>

        <!-- Widok Ustawień -->
        <div id="settingsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight text-left">Ustawienia</h2>
                    <button onclick="window.toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all text-left"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="flex bg-gray-100 dark:bg-zinc-900 p-1 rounded-2xl mb-4 overflow-x-auto no-scrollbar">
                    <button onclick="window.switchSettingsTab('config')" id="tabBtnConfig" class="flex-1 min-w-[80px] py-2.5 rounded-xl text-[11px] font-black uppercase transition-all bg-white dark:bg-zinc-800 shadow-sm text-dpd-red">Konfiguracja</button>
                    <button onclick="window.switchSettingsTab('history')" id="tabBtnHistory" class="flex-1 min-w-[80px] py-2.5 rounded-xl text-[11px] font-black uppercase transition-all text-gray-400">Historia dni</button>
                    <button onclick="window.switchSettingsTab('doc')" id="tabBtnDoc" class="flex-1 min-w-[80px] py-2.5 rounded-xl text-[11px] font-black uppercase transition-all text-gray-400">Dokumentacja</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40 text-left">
                <div id="tabContentConfig" class="tab-content active space-y-6">
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <div class="flex flex-col text-left">
                            <span class="text-sm font-bold text-left">Włącz AI</span>
                            <span class="text-xs opacity-60 text-left">Automatyczna analiza adresu i notatek</span>
                        </div>
                        <input type="checkbox" id="setAiEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Provider AI</label>
                        <select id="setAiProvider" onchange="window.applySettings(); window.updateApiKeyPlaceholder();" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 mt-1 cursor-pointer">
                            <option value="groq">Groq (darmowe ~14k/dzień)</option>
                            <option value="together">Together AI (darmowe)</option>
                            <option value="openai">OpenAI (darmowy tier)</option>
                            <option value="huggingface">Hugging Face (darmowe)</option>
                            <option value="gemini">Google Gemini</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left" id="apiKeyLabel">Klucz API</label>
                        <div class="flex items-center gap-2">
                            <input type="password" id="setGeminiKey" placeholder="Wklej klucz API..." class="flex-1 bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                            <button onclick="window.testApiKey(); setTimeout(() => lucide.createIcons(), 100);" class="p-2 bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 rounded-full active:scale-90 transition-colors" title="Testuj klucz API">
                                <i data-lucide="test-tube" class="w-4 h-4 text-dpd-red"></i>
                            </button>
                            <button onclick="window.listAvailableModels(); setTimeout(() => lucide.createIcons(), 100);" class="p-2 bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 rounded-full active:scale-90 transition-colors" title="Pokaż dostępne modele">
                                <i data-lucide="list" class="w-4 h-4 text-dpd-red"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-[10px] opacity-60" id="providerInfo"></div>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Motyw Aplikacji</label>
                        <select id="setTheme" onchange="window.applySettings()" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 mt-1 cursor-pointer">
                            <option value="light">Jasny</option>
                            <option value="dark">Ciemny</option>
                            <option value="auto">Auto (Wschód/Zachód)</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Miasto Główne</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="setCity" placeholder="Np. Wrocław" class="flex-1 bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                            <button onclick="window.updateCityFromGps()" class="p-2 bg-gray-200 dark:bg-zinc-700 rounded-full active:scale-90"><i data-lucide="map-pin" class="w-4 h-4 text-dpd-red"></i></button>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Hasło notatki (fallback)</label>
                        <input type="text" id="setStopWord" placeholder="notatka" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                    </div>
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <span class="text-sm font-bold text-left">Używaj GPS</span>
                        <input type="checkbox" id="setGpsEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                    <button onclick="window.handleConfirmAction('clear_all')" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-red-600 dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        <span>Wyczyść całą bazę danych</span>
                    </button>
                    <button onclick="window.exportBackup()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-dpd-red dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>Eksportuj backup (JSON)</span>
                    </button>
                    <button onclick="document.getElementById('importBackupInput').click()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-dpd-red dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        <span>Importuj backup</span>
                    </button>
                    <input type="file" id="importBackupInput" accept=".json" style="display: none;" onchange="window.importBackup(event)">
                    <button onclick="window.clearGeocodeCache()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-gray-700 dark:text-zinc-300 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Wyczyść cache geokodowania</span>
                    </button>
                    <div id="fileProtocolWarning" style="display: none;" class="bg-orange-50 dark:bg-orange-950/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-900/30 mb-4">
                        <p class="text-xs font-black uppercase text-orange-600 dark:text-orange-400 mb-2">⚠️ Uwaga: file://</p>
                        <p class="text-[11px] text-orange-700 dark:text-orange-300 mb-2">Chrome nie zapamiętuje uprawnień dla file://. Użyj localhost:</p>
                        <code class="text-xs bg-orange-100 dark:bg-orange-900/50 p-2 rounded block font-mono">python -m http.server 8000</code>
                        <p class="text-[11px] text-orange-600 dark:text-orange-400 mt-2">Następnie otwórz: <code class="font-mono">http://localhost:8000</code></p>
                    </div>
                </div>
                <!-- Historia -->
                <div id="tabContentHistory" class="tab-content space-y-4">
                    <div id="historyList" class="space-y-4"></div>
                </div>
                <!-- Dokumentacja -->
                <div id="tabContentDoc" class="tab-content space-y-4">
                    <div class="bg-gray-50 dark:bg-zinc-900 p-5 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <h3 class="text-xs font-black uppercase text-dpd-red mb-3">Strażnik Funkcji v1.7</h3>
                        <ul class="space-y-3 text-xs font-bold text-gray-500 dark:text-zinc-400 text-left">
                            <li class="flex items-start gap-2"><i data-lucide="check-circle" class="w-3 h-3 text-green-500 mt-0.5 shrink-0 text-left"></i> <span><b>Dark Mode Colors:</b> Naprawiono kolorystykę pasków bocznych (czerwony/grafitowy) na liście w trybie ciemnym.</span></li>
                            <li class="flex items-start gap-2"><i data-lucide="check-circle" class="w-3 h-3 text-green-500 mt-0.5 shrink-0 text-left"></i> <span><b>Mapa v1.5+:</b> Grupowanie stopów pod tym samym adresem. Markery z licznikiem i dymkiem listy. Dynamiczny przycisk Mapa/Lista.</span></li>
                            <li class="flex items-start gap-2"><i data-lucide="check-circle" class="w-3 h-3 text-green-500 mt-0.5 shrink-0 text-left"></i> <span><b>Czyszczenie:</b> Słowa "odbiór" i "odebrać" są usuwane z nazwy adresu po detekcji typu stopu.</span></li>
                            <li class="flex items-start gap-2"><i data-lucide="check-circle" class="w-3 h-3 text-green-500 mt-0.5 shrink-0 text-left"></i> <span><b>Parsowanie:</b> Bezwzględne usuwanie spacji wokół `/` oraz ochrona nazw ulic (Wiatraczna).</span></li>
                            <li class="flex items-start gap-2"><i data-lucide="check-circle" class="w-3 h-3 text-green-500 mt-0.5 shrink-0 text-left"></i> <span><b>Nagłówek:</b> Trzy liczniki. Brak daty u góry.</span></li>
                        </ul>
                        <p class="mt-4 text-[8px] opacity-40 uppercase font-black text-center text-left">Nie usuwać bez wyraźnego polecenia</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modale -->
    <div id="confirmModal" class="fixed inset-0 z-[300] bg-black/80 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform text-center">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-dpd-red mx-auto mb-4 text-left"></i>
            <h3 class="text-lg font-black uppercase mb-2">Potwierdź akcję</h3>
            <p id="confirmModalText" class="text-xs text-gray-500 mb-6 font-medium">Czy na pewno chcesz to zrobić?</p>
            <div class="flex gap-3 text-left">
                <button onclick="window.closeConfirmModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button id="confirmBtnAction" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Tak</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 z-[200] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-95 transition-transform">
            <h3 class="text-lg font-black uppercase mb-4 text-dpd-red text-left">Edytuj Stop</h3>
            <div class="space-y-4 text-left">
                <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded-2xl">
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase text-left">Adres</label>
                    <input type="text" id="editAddrInput" class="w-full bg-transparent border-none text-base font-bold focus:ring-0 outline-none p-0">
                </div>
                <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded-2xl">
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase text-left">Notatka</label>
                    <textarea id="editNoteInput" rows="3" class="w-full bg-transparent border-none text-base font-bold focus:ring-0 outline-none p-0 resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6 text-left">
                <button onclick="window.closeEditModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button onclick="window.saveEdit()" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Zapisz</button>
            </div>
        </div>
    </div>

    <div id="tipModal" class="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform text-left">
            <h3 class="text-lg font-black uppercase mb-1 text-dpd-red text-left">Napiwek</h3>
            <p id="tipAddress" class="text-xs text-gray-400 mb-4 font-bold uppercase truncate text-left"></p>
            <input type="number" id="tipInput" placeholder="0.00" step="0.50" inputmode="decimal" class="w-full bg-gray-100 dark:bg-zinc-800 border-none rounded-xl p-4 text-2xl font-black mb-4 focus:ring-2 focus:ring-dpd-red outline-none">
            <div class="flex gap-3 text-left">
                <button onclick="window.closeTipModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button onclick="window.confirmTip()" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Panel Dolny -->
    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 z-30 text-left">
        <div class="h-12 bg-gradient-to-t from-gray-100 dark:from-black to-transparent"></div>
        <div class="bg-gray-100 dark:bg-black safe-bottom px-6 pb-6">
            <div class="max-w-md mx-auto flex justify-around items-center bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl border border-gray-200 dark:border-zinc-800 p-4 relative text-left text-left">
                <button onclick="window.handleConfirmAction('reset_day')" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-red text-left text-left">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                    <span class="text-xs font-bold uppercase">Reset</span>
                </button>
                <div class="relative -top-10 text-center">
                    <button id="micBtn" onclick="window.toggleRecognition()" class="bg-dpd-red text-white w-20 h-20 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all border-4 border-white dark:border-zinc-900">
                        <i data-lucide="mic" id="micIcon" class="w-10 h-10 text-center"></i>
                    </button>
                    <div id="micLabel" class="text-xs font-bold text-dpd-red mt-1 opacity-0 transition-opacity uppercase font-black text-center text-left">Słucham...</div>
                </div>
                <button onclick="window.exportToCSV()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-dark text-left">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6 text-left"></i>
                    <span class="text-xs font-bold uppercase text-left">Raport</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-dpd-dark text-white px-6 py-3 rounded-xl text-base font-bold shadow-xl opacity-0 transition-all pointer-events-none z-[60] flex items-center gap-2 text-left">
        <i id="toastIcon" data-lucide="info" class="w-4 h-4 text-left"></i><span id="toastText"></span>
    </div>

    <script>
        const apiKeyDefault = ""; 
        let addresses = [];
        try { addresses = JSON.parse(localStorage.getItem('dpd_logs_v13') || '[]'); } catch(e) { addresses = []; }
        
        let config = JSON.parse(localStorage.getItem('dpd_config_v12') || JSON.stringify({
            name: "", stopWord: "notatka", theme: "auto", gpsEnabled: true, city: "", geminiKey: "", aiEnabled: true, geminiModel: "", aiProvider: "groq"
        }));
        
        // System prompt dla AI
        const aiSystemPrompt = `Jesteś asystentem kuriera DPD pracującego w Polsce. Otrzymujesz tekst podyktowany głosowo przez kuriera, który może zawierać błędy transkrypcji. Twoim zadaniem jest wyodrębnić z tego tekstu następujące informacje i zwrócić je w formacie JSON:

POLA WYJŚCIOWE:
- address: Adres dostawy/odbioru (nazwa ulicy + numer, np. "Andyjska 21a/5", "Himalajska 2a")
- type: Typ stopa - "delivery" (doręczenie) lub "pickup" (odbiór)
- note: Notatka z dodatkowymi informacjami (np. "zostawiona u sąsiada pod piątką", "pani jest bardzo miła")
- tip: Napiwek w złotych (liczba, np. 20 dla "20 złotych", 0 jeśli brak)

KRYTYCZNE ZASADY:
1. ZAWSZE zachowuj ukośniki w adresach - to jest BARDZO WAŻNE! (21f/3, 24b/23c, 15/17, 21f/13a, 21a/5)
2. Usuwaj TYLKO spacje wokół ukośników, NIE usuwaj samych ukośników (21 f / 3 -> 21f/3, NIE 21f3)
3. Napraw błędy transkrypcji mowy:
   - Liczby słowne na cyfry: "osiem naście" -> 18, "dwadzieścia jeden" -> 21, "pięć" -> 5
   - "przez", "na", "łamane" -> "/" (21a przez 3 -> 21a/3)
   - "f" może być rozpoznane jako "ef", "efek" itp. -> zawsze "f"
4. NIE zmieniaj nazw ulic - zachowaj oryginalną nazwę (Andyjska, Himalajska, Wiatraczna)
5. Formatuj adresy: pierwsza litera wielka, reszta mała (Andyjska 21a/5, Himalajska 2a)
6. WAŻNE: Adres może kończyć się literą lub cyfrą (np. 21f/13a, 21f/13, 2a). Pojedyncze litery po adresie (np. 'a', 'b', 'f') SĄ CZĘŚCIĄ ADRESU, NIE NOTATKI!
7. Typ stopa:
   - "delivery" (doręczenie) - domyślnie, chyba że wyraźnie wspomniano o odbiorze
   - "pickup" (odbiór) - tylko jeśli kurier mówi o "odbiorze", "odebraniu", "odbiorze paczki"
8. Notatka - wyodrębnij wszystkie dodatkowe informacje które NIE są adresem ani napiwkiem:
   - "zostawiona u sąsiada pod piątką" -> note: "zostawiona u sąsiada pod piątką"
   - "pani jest bardzo miła" -> note: "pani jest bardzo miła"
   - "paczka na piętrze" -> note: "paczka na piętrze"
9. Napiwek - wyodrębnij kwotę jeśli jest wspomniana:
   - "dostałem napiwek 20 złotych" -> tip: 20
   - "napiwek 15 zł" -> tip: 15
   - "20 zł napiwek" -> tip: 20
   - Jeśli brak wzmianki o napiwku -> tip: 0
10. Uwzględniaj niedoskonałości transkrypcji - tekst może być niepoprawnie rozpoznany, staraj się go zinterpretować w kontekście adresów polskich.

PRZYKŁADY:
- "Andyjska 21a przez 5 zostawiona u sąsiada pod piątką" -> {"address": "Andyjska 21a/5", "type": "delivery", "note": "zostawiona u sąsiada pod piątką", "tip": 0}
- "Himalajska 2a dostałem napiwek 20 złotych pani jest bardzo miła" -> {"address": "Himalajska 2a", "type": "delivery", "note": "pani jest bardzo miła", "tip": 20}
- "Wiatraczna 21f przez 13 odbiór" -> {"address": "Wiatraczna 21f/13", "type": "pickup", "note": "", "tip": 0}`;

        let isRecording = false, isProcessingAI = false, lastTranscript = "", interimTranscript = "";
        let wakeLock = null, currentView = 'list', map = null, markersGroup = null;
        let activeTipId = null, activeEditId = null, sunTimes = null;
        let silenceTimeout = null; // Timeout dla automatycznego zatrzymania po braku mowy
        
        // Cache geokodowania
        let geocodeCache = {};
        try { geocodeCache = JSON.parse(localStorage.getItem('geocode_cache_v1') || '{}'); } catch(e) { geocodeCache = {}; }
        
        // Detekcja platformy - cross-platform compatibility
        const platform = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1),
            isAndroid: /Android/.test(navigator.userAgent),
            isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            isDesktop: !/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            hasWakeLock: 'wakeLock' in navigator,
            hasVibration: 'vibrate' in navigator,
            hasGeolocation: 'geolocation' in navigator,
            hasSpeechRecognition: !!(window.webkitSpeechRecognition || window.SpeechRecognition),
            hasPermissionsAPI: 'permissions' in navigator,
            isHTTPS: location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
            isFileProtocol: location.protocol === 'file:'
        };
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Safe vibration - działa tylko na urządzeniach z wibracją
        function safeVibrate(pattern) {
            if (platform.hasVibration && platform.isMobile) {
                try {
                    navigator.vibrate(pattern);
                } catch(e) {
                    // Ignoruj błędy wibracji
                }
            }
        }

        function getTodayStr() {
            const d = new Date();
            return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
        }

        // --- MODALE & AKCJE ---
        window.handleConfirmAction = function(type, id = null) {
            const modal = document.getElementById('confirmModal');
            const text = document.getElementById('confirmModalText');
            const btn = document.getElementById('confirmBtnAction');
            if (type === 'delete_stop') {
                text.textContent = "Usunąć ten adres z listy?";
                btn.onclick = () => { window.deleteAddress(id); window.closeConfirmModal(); };
            } else if (type === 'reset_day') {
                text.textContent = "Wyczyścić dzisiejszą listę stopów?";
                btn.onclick = () => { window.confirmReset(); window.closeConfirmModal(); };
            } else if (type === 'clear_all') {
                text.textContent = "UWAGA! To usunie CAŁĄ historię. Kontynuować?";
                btn.onclick = () => { window.confirmAllClear(); window.closeConfirmModal(); };
            }
            modal.classList.add('modal-active');
        };

        window.closeConfirmModal = () => document.getElementById('confirmModal').classList.remove('modal-active');

        window.openEditModal = function(id) {
            activeEditId = id;
            const item = addresses.find(a => a.id === id);
            if (item) {
                document.getElementById('editAddrInput').value = item.address;
                document.getElementById('editNoteInput').value = item.note || "";
                document.getElementById('editModal').classList.add('modal-active');
                setTimeout(() => document.getElementById('editAddrInput').focus(), 100);
            }
        };

        window.closeEditModal = () => document.getElementById('editModal').classList.remove('modal-active');

        window.saveEdit = function() {
            const idx = addresses.findIndex(a => a.id === activeEditId);
            if (idx !== -1) {
                const oldAddr = addresses[idx].address;
                const newAddr = document.getElementById('editAddrInput').value.trim();
                if (!newAddr || newAddr.length < 2) {
                    window.showToast("Adres jest zbyt krótki", "alert-circle", "text-red-500");
                    return;
                }
                addresses[idx].address = newAddr;
                addresses[idx].note = document.getElementById('editNoteInput').value.trim();
                // Jeśli adres się zmienił, wyczyść współrzędne i geokoduj ponownie
                if (oldAddr !== newAddr) {
                    addresses[idx].lat = null;
                    addresses[idx].lng = null;
                    if (config.gpsEnabled) {
                        window.geocodeAddress(newAddr).then(coords => {
                            if (coords) {
                                addresses[idx].lat = coords.lat;
                                addresses[idx].lng = coords.lng;
                                localStorage.setItem('dpd_logs_v13', JSON.stringify(addresses));
                                if (currentView === 'map') window.renderMarkers();
                            }
                        });
                    }
                }
                window.saveAndRender();
                window.showToast("Zaktualizowano", "pencil", "text-blue-500");
            }
            window.closeEditModal();
        };

        // --- UI & PARSOWANIE ---
        window.setAIStatusUI = function() {
            const dot = document.getElementById('aiDot');
            const label = document.getElementById('aiStatusLabel');
            if (dot && label) {
                if (!config.aiEnabled) {
                    dot.className = "w-1.5 h-1.5 bg-gray-500 rounded-full transition-colors";
                    label.textContent = "AI: WYŁ";
                } else if (!config.geminiKey || config.geminiKey.trim().length === 0) {
                    dot.className = "w-1.5 h-1.5 bg-yellow-500 rounded-full transition-colors";
                    label.textContent = "AI: BRAK KLUCZA";
                } else if (isProcessingAI) {
                    dot.className = "w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse transition-colors";
                    label.textContent = "AI: ANALIZA";
                } else {
                    dot.className = "w-1.5 h-1.5 bg-green-500 rounded-full transition-colors";
                    label.textContent = "AI: OK";
                }
            }
        };

        window.setUIProcessing = function(proc) {
            isProcessingAI = proc;
            const b = document.getElementById('micBtn');
            const l = document.getElementById('micLabel');
            if (proc) { b?.classList.add('pulse-ai'); if (l) { l.textContent = "Analiza..."; l.style.opacity = '1'; } }
            else { b?.classList.remove('pulse-ai'); if (l) { l.textContent = "Słucham..."; l.style.opacity = '0'; } }
            window.setAIStatusUI();
        };

        window.showToast = function(m, i, c) {
            const t = document.getElementById('toast');
            const text = document.getElementById('toastText');
            const icon = document.getElementById('toastIcon');
            if (!t || !text || !icon) return;
            text.textContent = m;
            icon.setAttribute('data-lucide', i);
            icon.className = `w-4 h-4 ${c}`;
            lucide.createIcons();
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        };

        window.updateCityFromGps = function() {
            if (!platform.hasGeolocation) {
                window.showToast("GPS nie jest dostępny", "map-pin-off", "text-red-500");
                return;
            }
            window.showToast("Pobieram miasto...", "map-pin", "text-blue-500");
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=10`);
                    const data = await res.json();
                    const city = data.address.city || data.address.town || data.address.village;
                    if (city) {
                        config.city = city;
                        document.getElementById('setCity').value = city;
                        localStorage.setItem('dpd_config_v12', JSON.stringify(config));
                        window.showToast(`Ustawiono: ${city}`, "check", "text-green-500");
                        sunTimes = null; window.refreshTheme();
                    }
                } catch(e) { 
                    console.error('GPS error:', e);
                    window.showToast("Błąd pobierania miasta", "x", "text-red-500"); 
                }
            }, (err) => {
                console.error('Geolocation error:', err);
                if (err.code === 1) {
                    window.showToast("Brak uprawnień do lokalizacji", "map-pin-off", "text-red-500");
                } else if (err.code === 2) {
                    window.showToast("Nie można określić lokalizacji", "map-pin-off", "text-red-500");
                } else {
                    window.showToast("Błąd GPS", "x", "text-red-500");
                }
            }, {
                timeout: 10000,
                enableHighAccuracy: platform.isMobile, // Tylko na mobile używaj wysokiej dokładności
                maximumAge: 300000 // Cache 5 minut
            });
        };

        window.geocodeAddress = async function(addr) {
            const search = addr.split('/')[0].trim();
            if (!search) return null;
            
            // Sprawdź cache
            const cacheKey = `${search.toLowerCase()}_${(config.city || '').toLowerCase()}`;
            if (geocodeCache[cacheKey]) {
                return geocodeCache[cacheKey];
            }
            
            let q = encodeURIComponent(search);
            if (config.city) q += encodeURIComponent(`, ${config.city}`);
            try {
                // Rate limiting - Nominatim wymaga max 1 req/s
                await new Promise(resolve => setTimeout(resolve, 1000));
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`);
                const data = await res.json();
                const result = data?.[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
                
                // Zapisz w cache (max 1000 wpisów)
                if (result) {
                    const keys = Object.keys(geocodeCache);
                    if (keys.length >= 1000) {
                        // Usuń najstarsze 100 wpisów
                        const oldest = keys.slice(0, 100);
                        oldest.forEach(k => delete geocodeCache[k]);
                    }
                    geocodeCache[cacheKey] = result;
                    localStorage.setItem('geocode_cache_v1', JSON.stringify(geocodeCache));
                }
                return result;
            } catch(e) { 
                console.error('Geocoding error:', e);
                return null; 
            }
        };

        window.refreshTheme = async function() {
            let target = config.theme;
            if (config.theme === 'auto') {
                const now = new Date();
                if (!sunTimes && config.city) {
                    const coords = await window.geocodeAddress(config.city);
                    if (coords) {
                        const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${coords.lat}&lng=${coords.lng}&formatted=0`);
                        const data = await res.json();
                        if (data.status === "OK") sunTimes = { sunrise: new Date(data.results.sunrise), sunset: new Date(data.results.sunset) };
                    }
                }
                if (sunTimes) target = (now >= sunTimes.sunrise && now < sunTimes.sunset) ? 'light' : 'dark';
                else target = (now.getHours() >= 7 && now.getHours() < 19) ? 'light' : 'dark';
            }
            document.documentElement.classList.toggle('dark', target === 'dark');
            const icon = document.getElementById('themeQuickIcon');
            if (icon) icon.setAttribute('data-lucide', target === 'dark' ? 'moon' : 'sun');
            const autoLabel = document.getElementById('themeAutoLabel');
            if (autoLabel) autoLabel.classList.toggle('hidden', config.theme !== 'auto');
            lucide.createIcons();
        };

        window.cycleThemeManual = function() {
            const modes = ['light', 'dark', 'auto'];
            config.theme = modes[(modes.indexOf(config.theme) + 1) % 3];
            document.getElementById('setTheme').value = config.theme;
            window.applySettings();
        };

        window.formatPolishNumbers = function(text) {
            if (!text) return '';
            let t = text.trim();
            
            // 1. Najpierw zachowaj oryginalną wielkość liter dla nazw ulic (pierwsza litera wielka)
            // Podziel na słowa, zachowując strukturę
            const words = t.split(/\s+/);
            
            // 2. Mapowanie liczb słownych na cyfry
            const numMap = { 'zero': '0', 'jeden': '1', 'dwa': '2', 'trzy': '3', 'cztery': '4', 'pięć': '5', 'sześć': '6', 'siedem': '7', 'osiem': '8', 'dziewięć': '9', 'dziesięć': '10' };
            Object.keys(numMap).forEach(w => {
                const regex = new RegExp(`\\b${w}\\b`, 'gi');
                t = t.replace(regex, numMap[w]);
            });
            
            // 3. Napraw liczby złożone (naście, dziesiąt)
            t = t.replace(/(\d+)\s+naście\b/gi, (m, g1) => (parseInt(g1) + 10).toString());
            t = t.replace(/(\d+)\s+dziesiąt\b/gi, (m, g1) => (parseInt(g1) * 10).toString());
            
            // 4. Najpierw zamień słowa "przez", "na", "łamane" na ukośniki
            // "21a przez 3" -> "21a/3", "21 na 3" -> "21/3"
            t = t.replace(/(\d+[a-z]?)\s+(przez|na|łamane|łamane\s+na)\s+(\d+[a-z]?)/gi, '$1/$3');
            
            // 5. Normalizuj różne warianty ukośników i spacji
            // "21 f / 3" -> "21f/3", "21 f/ 3" -> "21f/3", "21f /3" -> "21f/3"
            t = t.replace(/(\d+[a-z]?)\s*\/\s*(\d+[a-z]?)/gi, '$1/$2');
            
            // 6. Wykryj i napraw wzorce bez ukośników (gdy rozpoznawanie mowy nie rozpoznało ukośnika)
            // Wzorzec 1: "21a 3" -> "21a/3" (gdy pierwsza część już ma literę, a potem jest cyfra)
            // Używamy bardziej precyzyjnego wzorca - tylko gdy druga część to mała cyfra (1-9) lub cyfra z literą
            t = t.replace(/(\d+[a-z])\s+(\d{1,2}[a-z]?)\b/gi, (match, part1, part2) => {
                // Jeśli mamy "21a 3" lub "21a 3b", zamień na "21a/3" lub "21a/3b"
                // Ale tylko jeśli druga część to mała liczba (1-99) - żeby nie łączyć z dużymi numerami ulic
                const num2 = parseInt(part2);
                if (num2 >= 1 && num2 <= 99) {
                    return `${part1}/${part2}`;
                }
                return match;
            });
            
            // Wzorzec 2: "21 f 3" -> "21f/3" (gdy pierwsza część to tylko cyfra, a litera jest osobno)
            t = t.replace(/(\d+)\s+([a-z])\s+(\d{1,2}[a-z]?)\b/gi, (match, num1, letter, num2) => {
                // Jeśli mamy "21 f 3", zamień na "21f/3"
                const num = parseInt(num2);
                if (/^[a-z]$/.test(letter) && num >= 1 && num <= 99) {
                    return `${num1}${letter}/${num2}`;
                }
                return match;
            });
            
            // 6. Usuń spacje wokół ukośników (zachowaj ukośnik!)
            t = t.replace(/\s*\/\s*/g, '/');
            
            // 7. Połącz cyfry z literami (21 f -> 21f, ale NIE zmieniaj nazw ulic)
            // Tylko jeśli jest cyfra przed literą i NIE ma już ukośnika po literze
            t = t.replace(/(\d+)\s+([a-z])(?!\s*\/)/gi, '$1$2');
            
            // 7. Normalizuj wielokrotne spacje
            t = t.replace(/\s+/g, ' ');
            
            // 8. Przywróć wielką literę na początku (dla nazw ulic)
            if (t.length > 0) {
                t = t.charAt(0).toUpperCase() + t.slice(1);
            }
            
            return t.trim();
        };

        // Uniwersalna funkcja do wywoływania różnych API AI
        window.callAIProvider = async function(provider, apiKey, text) {
            const systemPrompt = aiSystemPrompt;
            
            switch(provider) {
                case 'groq':
                    try {
                        // Groq może nie obsługiwać response_format dla wszystkich modeli
                        // Użyjmy modelu który na pewno obsługuje JSON mode
                        const requestBody = {
                            model: 'llama-3.1-8b-instant', // Lżejszy model, lepsza kompatybilność
                            messages: [
                                { role: 'system', content: systemPrompt + ' Odpowiedz TYLKO w formacie JSON: {"address": "...", "note": "...", "type": "delivery"|"pickup", "tip": 0}. Pamiętaj: pojedyncze litery po adresie są częścią adresu, NIE notatki! Napiwek to liczba w złotych (0 jeśli brak).' },
                                { role: 'user', content: `Tekst podyktowany przez kuriera: "${text}"` }
                            ],
                            temperature: 0.3,
                            max_tokens: 200
                        };
                        
                        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!res.ok) {
                            const errorData = await res.json().catch(() => ({}));
                            console.error('Groq API error:', res.status, errorData);
                            throw new Error(`Groq API ${res.status}: ${errorData.error?.message || JSON.stringify(errorData)}`);
                        }
                        
                        const data = await res.json();
                        const content = data.choices?.[0]?.message?.content || '';
                        
                        if (!content) {
                            throw new Error('Pusta odpowiedź z Groq API');
                        }
                        
                        // Spróbuj wyciągnąć JSON z odpowiedzi (może być otoczony tekstem)
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            return JSON.parse(jsonMatch[0]);
                        }
                        
                        // Jeśli nie ma JSON, spróbuj sparsować całą odpowiedź
                        return JSON.parse(content);
                    } catch (e) {
                        console.error('Groq error:', e);
                        throw e;
                    }
                    
                case 'together':
                    try {
                        const res = await fetch('https://api.together.xyz/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'meta-llama/Llama-3-70b-chat-hf',
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: `Tekst podyktowany przez kuriera: "${text}"` }
                                ],
                                response_format: { type: 'json_object' }
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const content = data.choices?.[0]?.message?.content || '';
                            return JSON.parse(content);
                        }
                        throw new Error(`Together AI: ${res.status}`);
                    } catch (e) {
                        console.error('Together error:', e);
                        throw e;
                    }
                    
                case 'openai':
                    try {
                        const res = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: `Tekst podyktowany przez kuriera: "${text}"` }
                                ],
                                response_format: { type: 'json_object' }
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const content = data.choices?.[0]?.message?.content || '';
                            return JSON.parse(content);
                        }
                        throw new Error(`OpenAI: ${res.status}`);
                    } catch (e) {
                        console.error('OpenAI error:', e);
                        throw e;
                    }
                    
                case 'huggingface':
                    try {
                        const res = await fetch('https://api-inference.huggingface.co/models/meta-llama/Llama-3-70b-chat-hf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                inputs: `System: ${systemPrompt}\n\nUser: Tekst podyktowany przez kuriera: "${text}"\n\nAssistant:`,
                                parameters: { return_full_text: false, max_new_tokens: 200 }
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const text = Array.isArray(data) ? data[0]?.generated_text : data?.generated_text || '';
                            const jsonMatch = text.match(/\{[\s\S]*\}/);
                            return jsonMatch ? JSON.parse(jsonMatch[0]) : {};
                        }
                        throw new Error(`Hugging Face: ${res.status}`);
                    } catch (e) {
                        console.error('Hugging Face error:', e);
                        throw e;
                    }
                    
                case 'gemini':
                default:
                    // Gemini API (oryginalna implementacja)
                    const modelsToTry = config.geminiModel 
                        ? [config.geminiModel, 'gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro']
                        : ['gemma-3-27b', 'gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'];
                    
                    for (const modelName of modelsToTry) {
                        try {
                            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: `Tekst podyktowany przez kuriera: "${text}"` }] }],
                                    systemInstruction: { parts: [{ text: systemPrompt }] },
                                    generationConfig: { responseMimeType: 'application/json' }
                                })
                            });
                            if (res.ok) {
                                const data = await res.json();
                                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                if (responseText) {
                                    if (config.geminiModel !== modelName) {
                                        config.geminiModel = modelName;
                                        localStorage.setItem('dpd_config_v12', JSON.stringify(config));
                                    }
                                    return JSON.parse(responseText);
                                }
                            } else if (res.status !== 404) {
                                throw new Error(`Gemini ${modelName}: ${res.status}`);
                            }
                        } catch (e) {
                            if (modelName === modelsToTry[modelsToTry.length - 1]) throw e;
                            continue;
                        }
                    }
                    throw new Error('Gemini: żaden model nie dostępny');
            }
        };
        
        window.handleVoiceResult = async function(text) {
            if (!text || text.trim().length < 2) return;
            let aiData = null;
            
            // Odśwież konfigurację z localStorage
            try {
                const savedConfig = JSON.parse(localStorage.getItem('dpd_config_v12') || '{}');
                Object.assign(config, savedConfig);
            } catch(e) {
                console.error('Error loading config:', e);
            }
            
            console.log('AI Provider:', config.aiProvider || 'gemini');
            console.log('API Key length:', config.geminiKey ? config.geminiKey.length : 0);
            
            if (config.aiEnabled) {
                window.setUIProcessing(true);
                try {
                    const finalKey = (config.geminiKey || apiKeyDefault).trim();
                    
                    if (!finalKey || finalKey.trim().length === 0) {
                        window.showToast("Brak klucza API", "alert-circle", "text-yellow-500");
                        window.setUIProcessing(false);
                        return;
                    }
                    
                    const provider = config.aiProvider || 'gemini';
                    aiData = await window.callAIProvider(provider, finalKey, text);
                    console.log('AI Response:', aiData);
                    
                } catch (e) {
                    console.error('AI error:', e);
                    if (e.message.includes('401') || e.message.includes('403')) {
                        window.showToast("Nieprawidłowy klucz API", "key", "text-red-500");
                    } else if (e.message.includes('404')) {
                        window.showToast("Model niedostępny. Sprawdź ustawienia.", "alert-circle", "text-yellow-500");
                    } else {
                        window.showToast("Błąd AI: " + e.message, "wifi-off", "text-red-500");
                    }
                    aiData = null;
                }
                window.setUIProcessing(false);
            }
            if (aiData && aiData.address) {
                // Upewnij się że tip jest liczbą (może być string z AI)
                const tip = parseFloat(aiData.tip) || 0;
                window.addEntry(aiData.address, aiData.note || "", aiData.type || 'delivery', tip);
            } else {
                // Fallback parsing bez AI
                const low = text.toLowerCase();
                const kw = (config.stopWord || "notatka").toLowerCase();
                
                // Szukaj słowa kluczowego "notatka" - musi być pełne słowo, nie część innego słowa
                // Użyj regex aby znaleźć "notatka" jako oddzielne słowo
                const kwRegex = new RegExp(`\\b${kw}\\b`, 'i');
                const splitMatch = text.match(kwRegex);
                const split = splitMatch ? splitMatch.index : -1;
                
                let type = (low.includes('odbiór') || low.includes('odebrać')) ? 'pickup' : 'delivery';
                let addr = text;
                let note = "";
                
                // Usuń słowa typu "odbiór" z adresu
                if (type === 'pickup') {
                    addr = addr.replace(/\b(odbiór|odebrać)\b/gi, '').trim();
                }
                
                // Podziel na adres i notatkę TYLKO jeśli znaleziono słowo kluczowe jako oddzielne słowo
                if (split !== -1 && splitMatch) { 
                    addr = text.substring(0, split).trim(); 
                    note = text.substring(split + splitMatch[0].length).trim(); 
                }
                
                // WAŻNE: Jeśli adres kończy się pojedynczą literą oddzieloną spacją (np. "21f/13 a"), 
                // połącz ją z adresem (nie traktuj jako notatki)
                // Wzorzec: spacja + pojedyncza litera na końcu adresu (po cyfrze lub ukośniku)
                addr = addr.replace(/\s+([a-z])\s*$/i, '$1'); // "21f/13 a" -> "21f/13a", "21 a" -> "21a"
                
                // Formatuj adres (zachowując ukośniki i poprawiając format)
                addr = window.formatPolishNumbers(addr);
                
                // Spróbuj wyodrębnić napiwek z notatki (fallback parsing)
                let tip = 0;
                const tipMatch = note.match(/(\d+(?:[.,]\d+)?)\s*(?:zł|zloty|zlotych|złotych|pln)/i);
                if (tipMatch) {
                    tip = parseFloat(tipMatch[1].replace(',', '.')) || 0;
                    // Usuń informację o napiwku z notatki
                    note = note.replace(/(?:napiwek|dostałem|otrzymałem)\s*(\d+(?:[.,]\d+)?)\s*(?:zł|zloty|zlotych|złotych|pln)/gi, '').trim();
                }
                
                window.addEntry(addr, note, type, tip);
            }
        };

        // Speech Recognition - cross-platform setup
        const Recog = window.webkitSpeechRecognition || window.SpeechRecognition;
        let recog = null;
        let micPermissionStatus = null;
        
        // Funkcja do sprawdzania uprawnień mikrofonu
        async function checkMicrophonePermission() {
            if (platform.hasPermissionsAPI) {
                try {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    micPermissionStatus = result.state;
                    result.onchange = () => {
                        micPermissionStatus = result.state;
                    };
                    return result.state;
                } catch (e) {
                    // Permissions API może nie wspierać 'microphone' na wszystkich przeglądarkach
                    return 'prompt';
                }
            }
            return 'prompt'; // Jeśli nie ma Permissions API, zakładamy że trzeba zapytać
        }
        
        if (!platform.hasSpeechRecognition) {
            // Ukryj przycisk mikrofonu jeśli nie ma wsparcia
            const micBtn = document.getElementById('micBtn');
            if (micBtn) {
                micBtn.style.opacity = '0.5';
                micBtn.title = "Rozpoznawanie mowy wymaga Chrome/Edge (PC) lub Safari (iOS)";
            }
            if (platform.isDesktop) {
                window.showToast("Rozpoznawanie mowy wymaga Chrome/Edge", "mic-off", "text-yellow-500");
            }
        } else {
            recog = new Recog();
            recog.lang = 'pl-PL'; 
            recog.interimResults = true;
            recog.continuous = true; // Ciągłe nagrywanie - użytkownik zatrzyma ręcznie przyciskiem
            recog.maxAlternatives = 1;
            
            // Sprawdź uprawnienia przy starcie
            checkMicrophonePermission();
            
            // Informacja o file:// protocol
            if (platform.isFileProtocol && platform.isDesktop) {
                console.warn('Aplikacja działa na file:// - Chrome nie zapamiętuje uprawnień. Użyj localhost dla lepszego doświadczenia.');
            }
            
            recog.onstart = () => {
                isRecording = true; lastTranscript = ""; interimTranscript = "";
                document.getElementById('micBtn')?.classList.add('pulse-red');
                document.getElementById('livePreview')?.classList.remove('hidden');
                const label = document.getElementById('micLabel');
                if (label) label.style.opacity = '1';
                safeVibrate(10); // Wibracja przy starcie nagrywania
                
                // NIE ustawiaj timeoutu od razu - tylko po wykryciu mowy
                // Wake Lock - tylko na platformach które to wspierają (Android Chrome)
                if (platform.hasWakeLock && !platform.isIOS) {
                    navigator.wakeLock.request('screen').then(w => {
                        wakeLock = w;
                        const wakeDot = document.getElementById('wakeDot');
                        const wakeText = document.getElementById('wakeText');
                        if (wakeDot) wakeDot.className = "w-1.5 h-1.5 bg-green-500 rounded-full transition-colors";
                        if (wakeText) wakeText.textContent = "Blokada: Wł";
                    }).catch(() => {
                        // Wake Lock nie działa (np. na iOS) - cicho ignoruj
                        const wakeDot = document.getElementById('wakeDot');
                        const wakeText = document.getElementById('wakeText');
                        if (wakeDot) wakeDot.className = "w-1.5 h-1.5 bg-red-500 rounded-full transition-colors";
                        if (wakeText) wakeText.textContent = "Blokada: Wył";
                    });
                } else if (platform.isIOS) {
                    // Na iOS Wake Lock nie działa - ukryj status
                    const wakeStatusBox = document.getElementById('wakeStatusBox');
                    if (wakeStatusBox) wakeStatusBox.style.display = 'none';
                }
            };
            recog.onresult = (e) => {
                let finalParts = [];
                let inter = '';
                
                // Zbierz wszystkie finalne wyniki (w trybie continuous są dodawane, nie zastępowane)
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        finalParts.push(e.results[i][0].transcript);
                    } else {
                        inter += e.results[i][0].transcript;
                    }
                }
                
                // Zaktualizuj lastTranscript - zbierz wszystkie finalne części
                if (finalParts.length > 0) {
                    // W trybie continuous, dodajemy nowe finalne części do istniejącego tekstu
                    lastTranscript = (lastTranscript ? lastTranscript + ' ' : '') + finalParts.join(' ');
                }
                
                interimTranscript = inter;
                
                // Resetuj timeout TYLKO gdy wykryto mowę (finalne lub interim wyniki)
                // Jeśli użytkownik mówi, przedłużamy timeout. Po sekundzie bez mowy zatrzyma się.
                if ((finalParts.length > 0 || inter.length > 0) && isRecording) {
                    if (silenceTimeout) clearTimeout(silenceTimeout);
                    silenceTimeout = setTimeout(() => {
                        if (isRecording && recog) {
                            // Zatrzymaj nagrywanie po sekundzie braku mowy
                            isRecording = false;
                            recog.stop();
                        }
                    }, 1000);
                }
                
                // Pokaż aktualny tekst (wszystkie finalne + interim)
                const displayText = (lastTranscript ? lastTranscript + (inter ? ' ' : '') : '') + inter;
                document.getElementById('liveText').textContent = displayText || "Słucham...";
            };
            recog.onend = () => {
                // Wyczyść timeout jeśli nagrywanie się zakończyło
                if (silenceTimeout) {
                    clearTimeout(silenceTimeout);
                    silenceTimeout = null;
                }
                
                isRecording = false;
                document.getElementById('micBtn')?.classList.remove('pulse-red');
                document.getElementById('livePreview')?.classList.add('hidden');
                const label = document.getElementById('micLabel');
                if (label) label.style.opacity = '0';
                safeVibrate([10, 50, 10]); // Podwójna wibracja przy zakończeniu
                
                if (wakeLock) {
                    wakeLock.release().then(() => { wakeLock = null; }).catch(() => {});
                    const wakeDot = document.getElementById('wakeDot');
                    const wakeText = document.getElementById('wakeText');
                    if (wakeDot) wakeDot.className = "w-1.5 h-1.5 bg-red-500 rounded-full transition-colors";
                    if (wakeText) wakeText.textContent = "Blokada: Wył";
                }
                const finalSpeech = lastTranscript || interimTranscript;
                if (finalSpeech && finalSpeech.trim().length > 0) {
                    window.handleVoiceResult(finalSpeech.trim());
                }
            };
            recog.onerror = (e) => {
                console.error('Speech recognition error:', e.error);
                if (e.error === 'not-allowed') {
                    micPermissionStatus = 'denied';
                    if (platform.isFileProtocol) {
                        window.showToast("Chrome nie zapamiętuje uprawnień dla file://. Użyj localhost.", "mic-off", "text-red-500");
                    } else {
                        window.showToast("Brak uprawnień do mikrofonu. Sprawdź ustawienia przeglądarki.", "mic-off", "text-red-500");
                    }
                } else if (e.error === 'no-speech') {
                    // Ciche ignorowanie - użytkownik może po prostu nie mówić
                } else if (e.error === 'network') {
                    window.showToast("Błąd sieci - sprawdź połączenie", "wifi-off", "text-red-500");
                } else if (e.error === 'service-not-allowed') {
                    window.showToast("Usługa rozpoznawania niedostępna", "x", "text-red-500");
                } else {
                    window.showToast("Błąd rozpoznawania mowy", "alert-circle", "text-red-500");
                }
            };
            window.toggleRecognition = async () => { 
                if (!isProcessingAI && recog) {
                    if (isRecording) {
                        // Zatrzymaj nagrywanie i przetwórz wynik
                        isRecording = false;
                        recog.stop();
                    } else {
                        // Sprawdź uprawnienia przed uruchomieniem
                        const permission = await checkMicrophonePermission();
                        
                        // Jeśli uprawnienia są odrzucone, pokaż komunikat
                        if (permission === 'denied') {
                            window.showToast("Uprawnienia do mikrofonu zostały zablokowane. Sprawdź ustawienia przeglądarki.", "mic-off", "text-red-500");
                            return;
                        }
                        
                        // Jeśli działa na file://, pokaż jednorazową informację
                        if (platform.isFileProtocol && platform.isDesktop && !localStorage.getItem('file_protocol_warning_shown')) {
                            window.showToast("Użyj localhost zamiast file:// aby Chrome zapamiętał uprawnienia", "info", "text-yellow-500");
                            localStorage.setItem('file_protocol_warning_shown', 'true');
                        }
                        
                        // Resetuj transkrypcje przed nowym nagraniem
                        lastTranscript = "";
                        interimTranscript = "";
                        
                        try {
                            recog.start();
                        } catch (e) {
                            console.error('Speech recognition start error:', e);
                            window.showToast("Nie można uruchomić rozpoznawania mowy", "mic-off", "text-red-500");
                        }
                    }
                }
            };
        }
        
        // Fallback jeśli nie ma Speech Recognition
        if (!platform.hasSpeechRecognition) {
            window.toggleRecognition = () => {
                window.showToast("Rozpoznawanie mowy nie jest dostępne w tej przeglądarce", "mic-off", "text-red-500");
            };
        }

        // --- ZAPIS I RENDER ---
        window.addEntry = function(addr, note = "", type = 'delivery', tip = 0) {
            if (!addr || addr.trim().length < 2) return;
            
            // Normalizuj adres - zachowaj ukośniki i popraw format
            let normalizedAddr = addr.trim();
            
            // Upewnij się, że ukośniki są zachowane (nie ma spacji wokół)
            normalizedAddr = normalizedAddr.replace(/\s*\/\s*/g, '/');
            
            // Wielka litera na początku (dla nazw ulic)
            if (normalizedAddr.length > 0) {
                normalizedAddr = normalizedAddr.charAt(0).toUpperCase() + normalizedAddr.slice(1);
            }
            
            // Upewnij się że tip jest liczbą
            const tipValue = parseFloat(tip) || 0;
            
            const entry = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }),
                date: getTodayStr(),
                address: normalizedAddr,
                note: (note || "").trim(),
                tip: tipValue, type, lat: null, lng: null
            };
            addresses.unshift(entry);
            window.saveAndRender();
            const tipMsg = tipValue > 0 ? ` + ${tipValue.toFixed(2)} zł napiwek` : '';
            window.showToast(`Dodano stop${tipMsg}`, "check", "text-green-500");
            if (config.gpsEnabled) {
            window.geocodeAddress(entry.address).then(coords => {
                if (coords) {
                    entry.lat = coords.lat; entry.lng = coords.lng;
                    localStorage.setItem('dpd_logs_v13', JSON.stringify(addresses));
                    if (currentView === 'map') window.renderMarkers();
                }
                }).catch(err => {
                    console.error('Geocoding error:', err);
            });
            }
        };

        window.saveAndRender = function() {
            localStorage.setItem('dpd_logs_v13', JSON.stringify(addresses));
            const today = getTodayStr();
            const todayLogs = addresses.filter(a => a.date === today);
            document.getElementById('deliveryCounter').textContent = todayLogs.filter(a => a.type === 'delivery').length;
            document.getElementById('pickupCounter').textContent = todayLogs.filter(a => a.type === 'pickup').length;
            document.getElementById('tipTotal').textContent = todayLogs.reduce((s, c) => s + (parseFloat(c.tip) || 0), 0).toFixed(2) + " zł";
            
            const listEl = document.getElementById('addressList');
            if (listEl) {
                if (todayLogs.length === 0) {
                    listEl.innerHTML = ''; document.getElementById('emptyState')?.classList.remove('hidden');
                } else {
                    document.getElementById('emptyState')?.classList.add('hidden');
                    listEl.innerHTML = todayLogs.map(item => `
                        <li class="bg-white dark:bg-zinc-800 p-4 rounded-2xl shadow-sm border-l-4 ${item.type === 'pickup' ? 'border-zinc-500' : 'border-dpd-red'} border-y border-r border-gray-100 dark:border-zinc-700">
                            <div class="flex justify-between items-start text-left">
                                <div class="flex-1">
                                    <span class="text-[10px] font-black uppercase opacity-60 text-left">${item.type === 'pickup' ? 'Odbiór' : 'Doręczenie'} ${item.time}</span>
                                    <p class="text-base font-bold mt-1 text-left">${item.address}</p>
                                </div>
                                <div class="flex gap-1 shrink-0 text-left">
                                    <button onclick="window.toggleType(${item.id})" class="p-1 opacity-40"><i data-lucide="${item.type === 'pickup' ? 'package-plus' : 'truck'}" class="w-4 h-4 text-left"></i></button>
                                    <button onclick="window.openEditModal(${item.id})" class="p-1 opacity-40"><i data-lucide="pencil" class="w-4 h-4 text-left"></i></button>
                                    <button onclick="window.openTipModal(${item.id})" class="p-1 ${item.tip > 0 ? 'text-green-500 opacity-100' : 'opacity-40'}"><i data-lucide="banknote" class="w-4 h-4 text-left"></i></button>
                                    <button onclick="window.handleConfirmAction('delete_stop', ${item.id})" class="p-1 text-red-400 opacity-40"><i data-lucide="trash-2" class="w-4 h-4 text-left"></i></button>
                                </div>
                            </div>
                            ${item.note ? `<p class="mt-2 text-xs opacity-60 italic border-t border-gray-50 dark:border-zinc-700 pt-1 text-left">${item.note}</p>` : ''}
                        </li>`).join('');
                }
            }
            lucide.createIcons();
            window.setAIStatusUI();
        };

        // --- MAPA & HISTORIA ---
        window.toggleView = function(v) {
            ['listView', 'mapView', 'settingsView'].forEach(id => document.getElementById(id).classList.add('view-hidden'));
            document.getElementById(v + 'View').classList.remove('view-hidden');
            currentView = v;
            const btnText = document.getElementById('toggleText');
            const btnIcon = document.getElementById('toggleIcon');
            if (v === 'map') {
                if (btnText) btnText.textContent = "Lista";
                if (btnIcon) btnIcon.setAttribute('data-lucide', 'list');
                if (!map) {
                    map = L.map('map', { zoomControl: false }).setView([52.23, 21.01], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    markersGroup = L.layerGroup().addTo(map);
                }
                setTimeout(() => { map.invalidateSize(); window.renderMarkers(); }, 200);
            } else {
                if (btnText) btnText.textContent = "Mapa";
                if (btnIcon) btnIcon.setAttribute('data-lucide', 'map');
            }
            lucide.createIcons();
        };

        window.handleMapToggle = () => currentView === 'map' ? window.toggleView('list') : window.toggleView('map');
        
        window.renderMarkers = () => {
            if (!markersGroup) return; markersGroup.clearLayers();
            const today = getTodayStr();
            const logs = addresses.filter(a => a.date === today && a.lat);
            if (!logs.length) return;
            const groups = {};
            logs.forEach(log => { const key = `${log.lat}_${log.lng}`; if (!groups[key]) groups[key] = []; groups[key].push(log); });
            const bounds = L.latLngBounds();
            Object.values(groups).forEach(stops => {
                const count = stops.length; const first = stops[0];
                const html = `<div class="marker-pin-wrapper"><i data-lucide="map-pin" class="w-8 h-8 text-dpd-red"></i>${count > 1 ? `<div class="marker-badge">${count}</div>` : ''}</div>`;
                const icon = L.divIcon({ html: html, className: 'custom-icon', iconSize: [32, 32], iconAnchor: [16, 32] });
                const popupContent = `<div class="p-2 min-w-[150px] text-left text-left"><p class="text-[10px] font-black uppercase text-dpd-red mb-2 border-b pb-1 text-left">${first.address}</p><ul class="space-y-2">${stops.map(s => `<li class="text-[9px] leading-tight text-left"><span class="font-bold">${s.time}</span> - <span class="${s.type === 'pickup' ? 'text-zinc-400' : 'text-dpd-red'} uppercase font-black">${s.type === 'pickup' ? 'Odbiór' : 'Doręcz'}</span>${s.note ? `<br><span class="opacity-60 italic">${s.note}</span>` : ''}</li>`).join('')}</ul></div>`;
                L.marker([first.lat, first.lng], { icon }).bindPopup(popupContent).addTo(markersGroup);
                bounds.extend([first.lat, first.lng]);
            });
            map.fitBounds(bounds, { padding: [50, 50] }); lucide.createIcons();
        };

        window.switchSettingsTab = (tab) => {
            ['config', 'history', 'doc'].forEach(t => { document.getElementById('tabBtn' + t.charAt(0).toUpperCase() + t.slice(1)).className = 'flex-1 min-w-[80px] py-2.5 rounded-xl text-[9px] font-black uppercase transition-all text-gray-400 text-left'; document.getElementById('tabContent' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('active'); });
            document.getElementById('tabBtn' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 'flex-1 min-w-[80px] py-2.5 rounded-xl text-[9px] font-black uppercase transition-all bg-white dark:bg-zinc-800 shadow-sm text-dpd-red';
            document.getElementById('tabContent' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (tab === 'history') window.renderHistory();
            lucide.createIcons();
        };

        window.renderHistory = () => {
            const list = document.getElementById('historyList');
            const grouped = addresses.reduce((acc, curr) => { if (!acc[curr.date]) acc[curr.date] = { date: curr.date, stops: [] }; acc[curr.date].stops.push(curr); return acc; }, {});
            const sorted = Object.keys(grouped).sort((a,b) => { const partsA = a.split('.'), partsB = b.split('.'); return new Date(partsB[2], partsB[1]-1, partsB[0]) - new Date(partsA[2], partsA[1]-1, partsA[0]); });
            list.innerHTML = sorted.map(k => `<div class="bg-gray-50 dark:bg-zinc-900/50 rounded-2xl border border-gray-100 dark:border-zinc-800 overflow-hidden mb-4"><div class="p-4 flex justify-between items-center bg-white/50 dark:bg-black/20 text-left"><div class="text-left"><p class="text-[11px] font-black uppercase text-dpd-red leading-none text-left">${grouped[k].date}</p></div><button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="p-2 text-gray-400 text-left"><i data-lucide="chevron-down" class="w-4 h-4 text-left"></i></button></div><div class="hidden p-4 space-y-2 border-t border-gray-100 dark:border-zinc-800 text-left">${grouped[k].stops.map(s => `<div class="flex justify-between text-[10px] text-left"><span>${s.time}</span><span class="flex-1 px-3 truncate opacity-80 text-left">${s.address}</span><span class="font-black ${s.type === 'pickup' ? 'text-zinc-400' : 'text-dpd-red'} text-left">${s.type === 'pickup' ? 'O' : 'D'}</span></div>`).join('')}</div></div>`).join('');
            lucide.createIcons();
        };

        window.updateApiKeyPlaceholder = function() {
            const provider = document.getElementById('setAiProvider')?.value || 'groq';
            const input = document.getElementById('setGeminiKey');
            const label = document.getElementById('apiKeyLabel');
            const info = document.getElementById('providerInfo');
            
            const providerInfo = {
                groq: { label: 'Klucz API Groq', placeholder: 'Wklej klucz API z console.groq.com...', info: '~14k darmowych zapytań/dzień' },
                together: { label: 'Klucz API Together AI', placeholder: 'Wklej klucz API z together.ai...', info: 'Darmowy tier dostępny' },
                openai: { label: 'Klucz API OpenAI', placeholder: 'Wklej klucz API z platform.openai.com...', info: 'GPT-3.5-turbo (darmowy tier)' },
                huggingface: { label: 'Token Hugging Face', placeholder: 'Wklej token z huggingface.co...', info: 'Darmowe modele open-source' },
                gemini: { label: 'Klucz API Google Gemini', placeholder: 'Wklej klucz API z Google AI Studio...', info: 'Google Gemini API' }
            };
            
            const infoText = providerInfo[provider] || providerInfo.groq;
            if (label) label.textContent = infoText.label;
            if (input) input.placeholder = infoText.placeholder;
            if (info) info.textContent = infoText.info;
        };
        
        window.applySettings = debounce(() => {
            config.aiEnabled = document.getElementById('setAiEnabled').checked;
            const newKey = document.getElementById('setGeminiKey').value.trim();
            config.geminiKey = newKey;
            config.aiProvider = document.getElementById('setAiProvider')?.value || 'groq';
            config.city = document.getElementById('setCity').value;
            config.theme = document.getElementById('setTheme').value;
            config.stopWord = document.getElementById('setStopWord').value || "notatka";
            config.gpsEnabled = document.getElementById('setGpsEnabled').checked;
            localStorage.setItem('dpd_config_v12', JSON.stringify(config));
            console.log('Settings saved. AI provider:', config.aiProvider, 'AI enabled:', config.aiEnabled);
            
            window.updateApiKeyPlaceholder();
            window.setAIStatusUI();
            
            sunTimes = null;
            window.refreshTheme();
            window.saveAndRender();
        }, 500);
        
        // Funkcja do listowania dostępnych modeli
        window.listAvailableModels = async function() {
            const key = document.getElementById('setGeminiKey').value.trim();
            if (!key) {
                window.showToast("Wprowadź klucz API", "alert-circle", "text-yellow-500");
                return;
            }
            
            window.showToast("Sprawdzam dostępne modele...", "loader", "text-blue-500");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                if (res.ok) {
                    const data = await res.json();
                    const models = data.models || [];
                    const generateContentModels = models
                        .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
                        .map(m => m.name.replace('models/', ''))
                        .sort();
                    
                    console.log('Dostępne modele:', generateContentModels);
                    const modelsList = generateContentModels.join(', ');
                    window.showToast(`Modele: ${modelsList.substring(0, 100)}${modelsList.length > 100 ? '...' : ''}`, "info", "text-green-500");
                    
                    // Zapisz pierwszy dostępny model jako sugerowany
                    if (generateContentModels.length > 0) {
                        const suggestedModel = generateContentModels.find(m => m.includes('gemini')) || generateContentModels[0];
                        console.log('Sugerowany model:', suggestedModel);
                    }
                    
                    return generateContentModels;
                } else {
                    const error = await res.json().catch(() => ({}));
                    console.error('List models error:', res.status, error);
                    window.showToast(`Błąd: ${res.status}`, "x", "text-red-500");
                }
            } catch (e) {
                console.error('List models exception:', e);
                window.showToast("Błąd: " + e.message, "wifi-off", "text-red-500");
            }
        };
        
        // Funkcja do testowania klucza API
        window.testApiKey = async function() {
            const key = document.getElementById('setGeminiKey').value.trim();
            if (!key) {
                window.showToast("Wprowadź klucz API", "alert-circle", "text-yellow-500");
                return;
            }
            
            const provider = document.getElementById('setAiProvider')?.value || config.aiProvider || 'groq';
            window.showToast(`Testuję klucz API (${provider})...`, "loader", "text-blue-500");
            
            try {
                await window.callAIProvider(provider, key, "Test");
                window.showToast(`Klucz API działa! (${provider})`, "check", "text-green-500");
            } catch (e) {
                console.error('API test error:', e);
                if (e.message.includes('401') || e.message.includes('403')) {
                    window.showToast("Nieprawidłowy klucz API", "key", "text-red-500");
                } else {
                    window.showToast(`Błąd: ${e.message}`, "x", "text-red-500");
                }
            }
        };
        window.toggleType = (id) => { const idx = addresses.findIndex(a => a.id === id); if (idx !== -1) { addresses[idx].type = addresses[idx].type === 'delivery' ? 'pickup' : 'delivery'; window.saveAndRender(); } };
        window.deleteAddress = (id) => { addresses = addresses.filter(a => a.id != id); window.saveAndRender(); window.showToast("Usunięto stop", "trash", "text-red-500"); };
        window.confirmReset = () => { const today = getTodayStr(); addresses = addresses.filter(a => a.date !== today); window.saveAndRender(); window.showToast("Zresetowano dzień", "trash", "text-red-500"); };
        window.confirmAllClear = () => { addresses = []; window.saveAndRender(); window.showToast("Wyczyszczono historię", "trash", "text-red-500"); };
        window.openTipModal = (id) => { 
            activeTipId = id; 
            const it = addresses.find(a => a.id === id); 
            if (it) { 
                document.getElementById('tipAddress').textContent = it.address; 
                document.getElementById('tipInput').value = it.tip > 0 ? it.tip : "";
                document.getElementById('tipModal').classList.add('modal-active'); 
                setTimeout(() => document.getElementById('tipInput').focus(), 100);
            } 
        };
        window.closeTipModal = () => document.getElementById('tipModal').classList.remove('modal-active');
        window.confirmTip = () => { const val = parseFloat(document.getElementById('tipInput').value) || 0; const idx = addresses.findIndex(a => a.id === activeTipId); if (idx !== -1) { addresses[idx].tip = val; window.saveAndRender(); } window.closeTipModal(); };
        window.exportToCSV = () => { const today = getTodayStr(); const data = addresses.filter(a => a.date === today); if (!data.length) { window.showToast("Brak danych do eksportu", "file-x", "text-yellow-500"); return; } let csv = "\uFEFFData;Godzina;Typ;Adres;Notatka;Napiwek;Szerokość;Długość\n" + data.map(r => `${r.date};${r.time};${r.type};"${r.address}";"${r.note}";${r.tip};${r.lat || ''};${r.lng || ''}`).join("\n"); const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(b); link.download = `Raport_${today.replace(/\./g, '_')}.csv`; link.click(); window.showToast("Eksportowano CSV", "file-spreadsheet", "text-green-500"); };
        
        window.exportBackup = () => {
            const backup = { addresses, config, version: '1.0', date: new Date().toISOString() };
            const json = JSON.stringify(backup, null, 2);
            const b = new Blob([json], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(b);
            link.download = `DPD_Backup_${getTodayStr().replace(/\./g, '_')}.json`;
            link.click();
            window.showToast("Eksportowano backup", "download", "text-green-500");
        };
        
        window.importBackup = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.addresses && Array.isArray(backup.addresses)) {
                        if (confirm(`Zaimportować ${backup.addresses.length} stopów? Obecne dane zostaną zastąpione.`)) {
                            addresses = backup.addresses;
                            if (backup.config) config = { ...config, ...backup.config };
                            localStorage.setItem('dpd_logs_v13', JSON.stringify(addresses));
                            localStorage.setItem('dpd_config_v12', JSON.stringify(config));
                            window.saveAndRender();
                            window.showToast("Zaimportowano backup", "upload", "text-green-500");
                        }
                    } else {
                        window.showToast("Nieprawidłowy format backupu", "alert-triangle", "text-red-500");
                    }
                } catch (err) {
                    window.showToast("Błąd importu", "x", "text-red-500");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        };
        
        window.clearGeocodeCache = () => {
            if (confirm("Wyczyścić cache geokodowania? Adresy będą geokodowane ponownie.")) {
                geocodeCache = {};
                localStorage.removeItem('geocode_cache_v1');
                window.showToast("Cache wyczyszczony", "trash", "text-green-500");
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('setAiEnabled').checked = config.aiEnabled !== false;
            document.getElementById('setGeminiKey').value = config.geminiKey || "";
            const providerSelect = document.getElementById('setAiProvider');
            if (providerSelect) providerSelect.value = config.aiProvider || "groq";
            document.getElementById('setCity').value = config.city || "";
            document.getElementById('setTheme').value = config.theme || "auto";
            document.getElementById('setStopWord').value = config.stopWord || "notatka";
            document.getElementById('setGpsEnabled').checked = config.gpsEnabled !== false;
            
            window.updateApiKeyPlaceholder();
            
            // Dodaj event listeners z debouncing
            document.getElementById('setGeminiKey').addEventListener('input', window.applySettings);
            document.getElementById('setCity').addEventListener('input', window.applySettings);
            document.getElementById('setStopWord').addEventListener('input', window.applySettings);
            
            if (!config.city && navigator.geolocation) window.updateCityFromGps();
            window.refreshTheme(); window.saveAndRender();
            setInterval(window.refreshTheme, 60000);
            
            // Platform-specific UI adjustments
            if (platform.isIOS) {
                // Na iOS ukryj Wake Lock status (nie działa)
                const wakeStatusBox = document.getElementById('wakeStatusBox');
                if (wakeStatusBox) wakeStatusBox.style.display = 'none';
            }
            
            if (platform.isDesktop) {
                // Na desktop dodaj informację o keyboard shortcuts
                document.body.setAttribute('data-platform', 'desktop');
            } else {
                document.body.setAttribute('data-platform', 'mobile');
            }
            
            // Pokaż ostrzeżenie o file:// jeśli aplikacja działa na file://
            const fileProtocolWarning = document.getElementById('fileProtocolWarning');
            if (fileProtocolWarning && platform.isFileProtocol) {
                fileProtocolWarning.style.display = 'block';
            }
            
            // Inicjalizuj ikony Lucide dla przycisków w ustawieniach
            lucide.createIcons();
            
            // Informacja o platformie w konsoli (dla debugowania)
            console.log('Platform detected:', {
                isIOS: platform.isIOS,
                isAndroid: platform.isAndroid,
                isMobile: platform.isMobile,
                isDesktop: platform.isDesktop,
                hasWakeLock: platform.hasWakeLock,
                hasVibration: platform.hasVibration,
                hasSpeechRecognition: platform.hasSpeechRecognition,
                isHTTPS: platform.isHTTPS
            });
            
            // Enter key support w modalach
            document.getElementById('editAddrInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('editNoteInput')?.focus();
            });
            document.getElementById('editNoteInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) window.saveEdit();
            });
            document.getElementById('tipInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') window.confirmTip();
            });
        });
    </script>
</body>
</html>