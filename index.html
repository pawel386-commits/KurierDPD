<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kurier Log - DPD AI Edition</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta id="theme-color-meta" name="theme-color" content="#dc0032">
    <meta name="apple-mobile-web-app-title" content="DPD Log AI">
    <link rel="apple-touch-icon" href="assets/icon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/tailwind-config.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="text-dpd-dark dark:text-gray-100 flex flex-col h-full overflow-hidden text-left transition-colors duration-300">

    <!-- Nagłówek -->
    <header class="bg-dpd-red text-white shadow-lg z-[80] w-full flex-none">
        <div class="header-safe-area"></div>
        <div class="p-4 pt-2 pb-4 text-left">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white px-2 py-1.5 rounded-lg inline-block shadow-sm">
                        <img src="https://www.dpd.com/wp-content/themes/DPD_NoLogin/images/DPD_logo_redgrad_rgb_responsive.svg" alt="DPD Logo" class="h-5 w-auto">
                    </div>
                    <div>
                        <p id="headerName" class="text-xs font-black uppercase tracking-wider leading-tight text-left">Kurier Log AI</p>
                        <p id="headerSubtitle" class="text-[10px] font-bold opacity-75 uppercase tracking-[0.2em] text-left">DPD Logistics</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2 text-right">
                    <div class="flex items-center gap-1.5 justify-end">
                        <div id="aiStatusBox" class="inline-flex items-center gap-1 text-[10px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10 shrink-0">
                            <div id="aiDot" class="w-1.5 h-1.5 bg-green-500 rounded-full transition-colors"></div> 
                            <span id="aiStatusLabel">AI: OK</span>
                        </div>
                        <div id="wakeStatusBox" class="inline-flex items-center gap-1 text-[10px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10 shrink-0">
                            <div id="wakeDot" class="w-1.5 h-1.5 bg-red-500 rounded-full transition-colors"></div> <span id="wakeText">Blokada: Wył</span>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center justify-end">
                        <button id="toggleBtn" onclick="window.handleMapToggle()" class="inline-flex items-center gap-2 text-xs font-bold bg-white text-dpd-red px-3 py-1.5 h-9 rounded-full uppercase shadow-md active:scale-95 transition-all">
                            <i data-lucide="map" id="toggleIcon" class="w-3.5 h-3.5"></i> <span id="toggleText">Mapa</span>
                        </button>
                        <button onclick="window.cycleThemeManual()" class="bg-black/20 w-9 h-9 flex flex-col items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                            <i id="themeQuickIcon" data-lucide="sun" class="w-4 h-4 text-white"></i>
                            <span id="themeAutoLabel" class="text-[8px] font-black uppercase mt-0.5 hidden leading-none">Auto</span>
                        </button>
                        <div class="relative">
                            <button onclick="window.toggleMenu()" class="bg-black/20 w-10 h-10 flex items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                                <i data-lucide="menu" class="w-5 h-5 text-white"></i>
                            </button>
                            <div id="menuDropdown" class="absolute right-0 top-12 bg-white dark:bg-zinc-800 rounded-2xl shadow-xl border border-gray-100 dark:border-zinc-700 w-48 py-2 hidden z-50 transform origin-top-right transition-all duration-200">
                                <button onclick="window.toggleView('settings'); window.toggleMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-700 flex items-center gap-3 text-sm font-bold text-gray-700 dark:text-gray-200">
                                    <i data-lucide="settings" class="w-4 h-4 text-gray-400"></i> Ustawienia
                                </button>
                                <button onclick="window.toggleView('aiSettings'); window.toggleMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-700 flex items-center gap-3 text-sm font-bold text-gray-700 dark:text-gray-200">
                                    <i data-lucide="bot" class="w-4 h-4 text-gray-400"></i> Ustawienia AI
                                </button>
                                <button onclick="window.toggleView('customers'); window.toggleMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-700 flex items-center gap-3 text-sm font-bold text-gray-700 dark:text-gray-200">
                                    <i data-lucide="users" class="w-4 h-4 text-gray-400"></i> Baza Klientów
                                </button>
                                <button onclick="window.toggleView('stats'); window.toggleMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-700 flex items-center gap-3 text-sm font-bold text-gray-700 dark:text-gray-200">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-gray-400"></i> Statystyki
                                </button>
                                <button onclick="window.toggleView('history'); window.toggleMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-zinc-700 flex items-center gap-3 text-sm font-bold text-gray-700 dark:text-gray-200">
                                    <i data-lucide="history" class="w-4 h-4 text-gray-400"></i> Historia
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Doręczenia</span>
                    <span id="deliveryCounter" class="text-xl font-black leading-none">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Odbiory</span>
                    <span id="pickupCounter" class="text-xl font-black leading-none text-zinc-300">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[10px] font-black uppercase opacity-80 tracking-tighter mb-0.5">Napiwki</span>
                    <span id="tipTotal" class="text-xl font-black leading-none text-green-300">0.00 zł</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-gray-100 dark:bg-zinc-900 text-left">
        <!-- Widok Listy -->
        <div id="listView" class="absolute inset-0 p-4 overflow-y-auto z-1">
            <div id="suggestionCard" class="hidden mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 dark:border-blue-400 rounded-xl shadow-lg relative z-20">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="text-[10px] font-black uppercase text-blue-500 tracking-wider">Sugestia Asystenta</span>
                        <h3 id="suggAddress" class="text-lg font-black text-gray-800 dark:text-gray-100 leading-tight"></h3>
                        <p id="suggName" class="text-sm font-medium text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <button onclick="window.closeSuggestion()" class="p-1 opacity-50 hover:opacity-100"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="suggNoteBox" class="bg-white dark:bg-zinc-900/50 p-2 rounded-lg mb-3 border border-blue-100 dark:border-blue-800/30 hidden">
                    <p id="suggNote" class="text-xs font-mono text-blue-600 dark:text-blue-300"></p>
                </div>
                <div class="flex gap-2">
                    <button id="suggCallBtn" class="flex-none w-12 h-12 flex items-center justify-center bg-green-500 text-white rounded-xl shadow-sm active:scale-95 transition-all">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                    </button>
                    <button id="suggConfirmBtn" class="flex-1 bg-blue-500 text-white rounded-xl font-black uppercase text-xs shadow-sm shadow-blue-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                        Potwierdź Stop
                    </button>
                </div>
            </div>
            <div id="livePreview" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700/50 rounded-xl text-sm italic text-gray-600 dark:text-yellow-200 hidden min-h-[40px] flex items-center gap-2 shadow-sm">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                </span>
                <span id="liveText" class="break-words">Słucham...</span>
            </div>
            <div id="emptyState" class="text-center py-20 text-gray-400 hidden">
                <i data-lucide="mic" class="w-16 h-16 mx-auto mb-4 opacity-10"></i>
                <p class="font-medium text-sm">Podyktuj adres (np. "Polna 5").</p>
            </div>
            <ul id="addressList" class="space-y-3 pb-64 text-left"></ul>
        </div>

        <!-- Widok Mapy -->
        <div id="mapView" class="absolute inset-0 z-0 view-hidden">
            <div id="map"></div>
        </div>

        <!-- Widok Zarządzania Klientami -->
        <div id="customersView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight text-left">Baza Klientów</h2>
                    <button onclick="window.toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all text-left"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="relative mb-4">
                    <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="customerSearch" oninput="window.renderCustomersList()" placeholder="Szukaj klienta..." class="w-full bg-gray-50 dark:bg-zinc-900 pl-10 pr-4 py-2.5 rounded-xl text-sm font-bold border-none outline-none focus:ring-2 focus:ring-dpd-red/20">
                </div>
            </div>
            <div id="customersList" class="flex-1 overflow-y-auto p-4 pt-0 space-y-3 pb-20"></div>
        </div>

        <!-- Widok Ustawień -->
        <div id="settingsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight text-left">Ustawienia</h2>
                    <button onclick="window.toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all text-left"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40 text-left space-y-4">
                <!-- Kafelek Konfiguracja -->
                <div class="bg-gray-50 dark:bg-zinc-900/50 rounded-2xl border border-gray-100 dark:border-zinc-800 overflow-hidden">
                    <button onclick="window.toggleConfigContent()" class="w-full p-4 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
                        <h3 class="text-sm font-black uppercase text-dpd-red">Konfiguracja</h3>
                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform" id="configChevron"></i>
                    </button>
                    <div id="configContent" class="p-4 pt-0 space-y-6">
                    
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Motyw Aplikacji</label>
                        <select id="setTheme" onchange="window.applySettings()" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 mt-1 cursor-pointer">
                            <option value="light">Jasny</option>
                            <option value="dark">Ciemny</option>
                            <option value="auto">Auto (Wschód/Zachód)</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Miasto Główne</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="setCity" placeholder="Np. Wrocław" class="flex-1 bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                            <button onclick="window.updateCityFromGps()" class="p-2 bg-gray-200 dark:bg-zinc-700 rounded-full active:scale-90"><i data-lucide="map-pin" class="w-4 h-4 text-dpd-red"></i></button>
                        </div>
                    </div>
                    
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <span class="text-sm font-bold text-left">Używaj GPS</span>
                        <input type="checkbox" id="setGpsEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <div class="flex flex-col text-left">
                            <span class="text-sm font-bold text-left">Nie wygaszaj ekranu</span>
                            <span class="text-xs opacity-60 text-left">Blokada wygaszania (Wake Lock)</span>
                        </div>
                        <input type="checkbox" id="setWakeLockEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                    
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <div class="flex flex-col text-left">
                            <span class="text-sm font-bold text-left">Wykrywanie powrotu</span>
                            <span class="text-xs opacity-60 text-left">Przypomnienie przy starcie silnika</span>
                        </div>
                        <input type="checkbox" id="setCarAssistantEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>

                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <div class="flex flex-col text-left">
                            <span class="text-sm font-bold text-left">Inteligentny Asystent (GPS)</span>
                            <span class="text-xs opacity-60 text-left">Sugeruj klientów w pobliżu</span>
                        </div>
                        <input type="checkbox" id="setSmartAssistantEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>

                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Promień sugestii (metry)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="setProximityRadius" min="10" max="200" step="10" oninput="document.getElementById('radiusValue').textContent = this.value + 'm'; window.applySettings()" class="flex-1 accent-dpd-red">
                            <span id="radiusValue" class="text-xs font-bold w-10 text-right">40m</span>
                        </div>
                    </div>

                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <div class="flex flex-col text-left">
                            <span class="text-sm font-bold text-left">Potwierdzenie głosowe</span>
                            <span class="text-xs opacity-60 text-left">Czytaj dodany adres</span>
                        </div>
                        <input type="checkbox" id="setVoiceConfirmationEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>

                    <button onclick="window.handleConfirmAction('clear_all')" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-red-600 dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">

                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        <span>Wyczyść całą bazę danych</span>
                    </button>
                    <button onclick="window.exportBackup()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-dpd-red dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>Eksportuj backup (JSON)</span>
                    </button>
                    <button onclick="window.exportFullCSV()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-green-600 dark:text-green-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                        <span>Eksportuj pełną historię (CSV)</span>
                    </button>
                    <button onclick="document.getElementById('importBackupInput').click()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-dpd-red dark:text-red-400 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        <span>Importuj backup</span>
                    </button>
                    <input type="file" id="importBackupInput" accept=".json" style="display: none;" onchange="window.importBackup(event)">
                    <button onclick="window.clearGeocodeCache()" class="w-full bg-gray-50 dark:bg-zinc-900/50 text-gray-700 dark:text-zinc-300 p-4 rounded-2xl font-black uppercase text-xs border border-gray-100 dark:border-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-800 active:scale-95 transition-all mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Wyczyść cache geokodowania</span>
                    </button>
                    <div id="fileProtocolWarning" style="display: none;" class="bg-orange-50 dark:bg-orange-950/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-900/30 mb-4">
                        <p class="text-xs font-black uppercase text-orange-600 dark:text-orange-400 mb-2">⚠️ Uwaga: file://</p>
                        <p class="text-[11px] text-orange-700 dark:text-orange-300 mb-2">Chrome nie zapamiętuje uprawnień dla file://. Użyj localhost:</p>
                        <code class="text-xs bg-orange-100 dark:bg-orange-900/50 p-2 rounded block font-mono">python -m http.server 8000</code>
                        <p class="text-[11px] text-orange-600 dark:text-orange-400 mt-2">Następnie otwórz: <code class="font-mono">http://localhost:8000</code></p>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widok Historii -->
        <div id="historyView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight text-left">Historia</h2>
                    <button onclick="window.toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all text-left"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40 text-left space-y-4">
                <div id="historyList" class="space-y-4"></div>
            </div>
        </div>

        <!-- Widok Statystyk -->
        <div id="statsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight text-left">Statystyki</h2>
                    <button onclick="window.toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all text-left"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40 text-left space-y-6">
                <div class="bg-gray-50 dark:bg-zinc-900/50 rounded-2xl border border-gray-100 dark:border-zinc-800 p-4">
                    <h3 class="text-sm font-black uppercase text-dpd-red mb-4">Stopy (Ostatnie 7 dni)</h3>
                    <div class="relative h-64">
                        <canvas id="stopsChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-zinc-900/50 rounded-2xl border border-gray-100 dark:border-zinc-800 p-4">
                    <h3 class="text-sm font-black uppercase text-dpd-red mb-4">Napiwki (Ostatnie 7 dni)</h3>
                    <div class="relative h-64">
                        <canvas id="tipsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widok Ustawień AI -->
        <div id="aiSettingsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none text-left">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2">
                        <button onclick="window.toggleView('settings')" class="p-2 -ml-2 bg-transparent rounded-full active:scale-90 transition-all text-left"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                        <h2 class="text-xl font-black uppercase tracking-tight text-left">Ustawienia AI</h2>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40 text-left space-y-4">
                 <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                     <div class="flex flex-col text-left">
                         <span class="text-sm font-bold text-left">Włącz AI</span>
                         <span class="text-xs opacity-60 text-left">Automatyczna analiza adresu i notatek</span>
                     </div>
                     <input type="checkbox" id="setAiEnabled" onchange="window.applySettings()" class="w-5 h-5 accent-dpd-red">
                 </label>
                 
                 <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                     <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Provider AI</label>
                     <select id="setAiProvider" onchange="window.applySettings(); window.updateApiKeyPlaceholder();" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 mt-1 cursor-pointer">
                         <option value="groq">Groq (darmowe ~14k/dzień)</option>
                         <option value="together">Together AI (darmowe)</option>
                         <option value="openai">OpenAI (darmowy tier)</option>
                         <option value="huggingface">Hugging Face (darmowe)</option>
                         <option value="gemini">Google Gemini</option>
                     </select>
                 </div>
                 
                 <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                     <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left" id="apiKeyLabel">Klucz API</label>
                     <div class="flex items-center gap-2">
                         <input type="password" id="setGeminiKey" placeholder="Wklej klucz API..." class="flex-1 bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                         <button onclick="window.testApiKey(); setTimeout(() => lucide.createIcons(), 100);" class="p-2 bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 rounded-full active:scale-90 transition-colors" title="Testuj klucz API">
                             <i data-lucide="test-tube" class="w-4 h-4 text-dpd-red"></i>
                         </button>
                         <button onclick="window.listAvailableModels(); setTimeout(() => lucide.createIcons(), 100);" class="p-2 bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 rounded-full active:scale-90 transition-colors" title="Pokaż dostępne modele">
                             <i data-lucide="list" class="w-4 h-4 text-dpd-red"></i>
                         </button>
                     </div>
                     <div class="mt-2 text-[10px] opacity-60" id="providerInfo"></div>
                 </div>
                 
                 <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                     <label class="text-xs font-bold text-gray-500 block mb-1 uppercase text-left">Hasło notatki (fallback)</label>
                     <input type="text" id="setStopWord" placeholder="notatka" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                 </div>
            </div>
        </div>
    </main>

    <!-- Modale -->
    <div id="confirmModal" class="fixed inset-0 z-[300] bg-black/80 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform text-center">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-dpd-red mx-auto mb-4 text-left"></i>
            <h3 class="text-lg font-black uppercase mb-2">Potwierdź akcję</h3>
            <p id="confirmModalText" class="text-xs text-gray-500 mb-6 font-medium">Czy na pewno chcesz to zrobić?</p>
            <div class="flex gap-3 text-left">
                <button onclick="window.closeConfirmModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button id="confirmBtnAction" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Tak</button>
            </div>
        </div>
    </div>

    <!-- Modal Edycji Klienta -->
    <div id="customerModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="window.closeCustomerModal()"></div>
        <div class="bg-white dark:bg-zinc-900 w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full sm:translate-y-0 transition-transform duration-300 pointer-events-auto shadow-2xl">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-zinc-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="text-lg font-black uppercase mb-4 text-left flex items-center gap-2">
                <i data-lucide="user" class="w-5 h-5 text-dpd-red"></i>
                <span id="customerModalTitle">Edycja Klienta</span>
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block text-left">Adres (Powiązanie)</label>
                    <input type="text" id="custAddress" class="w-full bg-gray-50 dark:bg-zinc-800 p-3 rounded-xl text-base font-bold border-none outline-none opacity-60" readonly>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block text-left">Lokalizacja (Mapa)</label>
                    <div id="customerMap" class="w-full h-48 bg-gray-200 dark:bg-zinc-800 rounded-xl mb-2 z-10 relative z-0"></div>
                    <button id="btnGpsCustomer" onclick="window.useCurrentGpsForCustomer()" class="w-full py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs font-black uppercase rounded-xl border border-blue-100 dark:border-blue-800/30 flex items-center justify-center gap-2 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                        <i data-lucide="crosshair" class="w-4 h-4"></i>
                        Użyj mojej pozycji GPS
                    </button>
                </div>
                
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block text-left">Imię i Nazwisko / Nazwa</label>
                    <input type="text" id="custName" placeholder="Np. Jan Kowalski" class="w-full bg-gray-100 dark:bg-zinc-800 p-4 rounded-xl text-lg font-bold border-2 border-transparent focus:border-dpd-red outline-none transition-colors">
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block text-left">Telefon</label>
                    <div class="flex gap-2">
                        <input type="tel" id="custPhone" placeholder="Np. 123 456 789" class="flex-1 bg-gray-100 dark:bg-zinc-800 p-4 rounded-xl text-lg font-bold border-2 border-transparent focus:border-dpd-red outline-none transition-colors">
                        <a id="custPhoneCall" href="#" class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 p-4 rounded-xl flex items-center justify-center opacity-50 pointer-events-none transition-opacity">
                            <i data-lucide="phone" class="w-6 h-6"></i>
                        </a>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block text-left">Stała Notatka</label>
                    <textarea id="custNote" rows="2" placeholder="Np. Kod do bramy 1234, zostawiać u sąsiada" class="w-full bg-gray-100 dark:bg-zinc-800 p-4 rounded-xl text-base font-medium border-2 border-transparent focus:border-dpd-red outline-none resize-none transition-colors"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="window.closeCustomerModal()" class="p-4 rounded-xl font-black uppercase text-xs bg-gray-100 dark:bg-zinc-800 text-gray-500 hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">Anuluj</button>
                    <button onclick="window.saveCustomer()" class="p-4 rounded-xl font-black uppercase text-xs bg-dpd-red text-white shadow-lg shadow-red-500/30 active:scale-95 transition-all">Zapisz</button>
                </div>
                
                <button id="btnDeleteCustomer" onclick="window.deleteCustomerCurrent()" class="w-full mt-2 p-3 text-red-500 text-xs font-bold uppercase opacity-60 hover:opacity-100 transition-opacity hidden">
                    Usuń powiązanie klienta
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Edycji -->
    <div id="editModal" class="fixed inset-0 z-[200] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-95 transition-transform">
            <h3 class="text-lg font-black uppercase mb-4 text-dpd-red text-left">Edytuj Stop</h3>
            <div class="space-y-4 text-left">
                <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded-2xl">
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase text-left">Adres</label>
                    <input type="text" id="editAddrInput" class="w-full bg-transparent border-none text-base font-bold focus:ring-0 outline-none p-0">
                </div>
                <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded-2xl">
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase text-left">Notatka</label>
                    <textarea id="editNoteInput" rows="3" class="w-full bg-transparent border-none text-base font-bold focus:ring-0 outline-none p-0 resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6 text-left">
                <button onclick="window.closeEditModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button onclick="window.saveEdit()" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Zapisz</button>
            </div>
        </div>
    </div>

    <div id="tipModal" class="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform text-left">
            <h3 class="text-lg font-black uppercase mb-1 text-dpd-red text-left">Napiwek</h3>
            <p id="tipAddress" class="text-xs text-gray-400 mb-4 font-bold uppercase truncate text-left"></p>
            <input type="number" id="tipInput" placeholder="0.00" step="0.50" inputmode="decimal" class="w-full bg-gray-100 dark:bg-zinc-800 border-none rounded-xl p-4 text-2xl font-black mb-4 focus:ring-2 focus:ring-dpd-red outline-none">
            <div class="flex gap-3 text-left">
                <button onclick="window.closeTipModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-4 rounded-2xl font-black uppercase text-xs">Anuluj</button>
                <button onclick="window.confirmTip()" class="flex-1 bg-dpd-red text-white py-4 rounded-2xl font-black uppercase text-xs">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Panel Dolny -->
    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 z-30 text-left">
        <div class="h-12 bg-gradient-to-t from-gray-100 dark:from-black to-transparent"></div>
        <div class="bg-gray-100 dark:bg-black safe-bottom px-6 pb-6">
            <div class="max-w-md mx-auto flex justify-around items-center bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl border border-gray-200 dark:border-zinc-800 p-4 relative text-left text-left">
                <button onclick="window.handleConfirmAction('reset_day')" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-red text-left text-left">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                    <span class="text-xs font-bold uppercase">Reset</span>
                </button>
                <div class="relative -top-10 text-center">
                    <button id="micBtn" onclick="window.toggleRecognition()" class="bg-dpd-red text-white w-20 h-20 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all border-4 border-white dark:border-zinc-900">
                        <i data-lucide="mic" id="micIcon" class="w-10 h-10 text-center"></i>
                    </button>
                    <div id="micLabel" class="text-xs font-bold text-dpd-red mt-1 opacity-0 transition-opacity uppercase font-black text-center text-left">Słucham...</div>
                </div>
                <button onclick="window.exportToCSV()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-dark text-left">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6 text-left"></i>
                    <span class="text-xs font-bold uppercase text-left">Raport</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-dpd-dark text-white px-6 py-3 rounded-xl text-base font-bold shadow-xl opacity-0 transition-all pointer-events-none z-[400] flex items-center gap-2 text-left">
        <i id="toastIcon" data-lucide="info" class="w-4 h-4 text-left"></i><span id="toastText"></span>
    </div>

    <!-- Application Logic -->
    <script src="js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed', err));
            });
        }
        
        // Funkcje UI które muszą być w global scope lub helpery
        window.toggleConfigContent = () => {
            const el = document.getElementById('configContent');
            const icon = document.getElementById('configChevron');
            el.classList.toggle('hidden');
            icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        };

        window.toggleHistoryContent = () => {
            const el = document.getElementById('historyContent');
            const icon = document.getElementById('historyChevron');
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                window.renderHistory();
                icon.style.transform = 'rotate(180deg)';
            } else {
                el.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        };
    </script>
</body>
</html>