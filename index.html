<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kurier Log - DPD AI Edition</title>
    
    <!-- iPhone Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta id="theme-color-meta" name="theme-color" content="#dc0032">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dpd: { red: '#dc0032', dark: '#2d2d2d', gray: '#f4f4f4', ai: '#8b5cf6' }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --dpd-red: #dc0032; }
        html { background-color: var(--dpd-red); transition: background-color 0.3s ease; }
        html.dark { background-color: #000000; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; background-color: #f4f4f4; height: 100%; }
        .dark body { background-color: #000000; }
        .header-safe-area { padding-top: env(safe-area-inset-top); background-color: var(--dpd-red); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* Pulse Animations */
        .pulse-red { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 0, 50, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 0, 50, 0); }
        }

        .pulse-ai { animation: pulse-ai 1s infinite; background-color: #8b5cf6 !important; }
        @keyframes pulse-ai {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(139, 92, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        #map { height: 100%; width: 100%; z-index: 1; }
        .view-hidden { display: none !important; }
        ::-webkit-scrollbar { display: none; }
        .modal-active { opacity: 1 !important; pointer-events: auto !important; }
        .modal-active > div { transform: scale(1) !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .marker-cluster-custom {
            background: #dc0032;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 220px !important; }

        /* iPhone Optimization */
        input, select, textarea { font-size: 16px !important; }
        .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="text-dpd-dark dark:text-gray-100 flex flex-col h-full overflow-hidden text-left transition-colors duration-300">

    <!-- Nagłówek -->
    <header class="bg-dpd-red text-white shadow-lg z-20 w-full flex-none text-left">
        <div class="header-safe-area"></div>
        <div class="p-4 pt-2 pb-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white px-2 py-1.5 rounded-lg inline-block shadow-sm">
                        <img src="https://www.dpd.com/wp-content/themes/DPD_NoLogin/images/DPD_logo_redgrad_rgb_responsive.svg" alt="DPD Logo" class="h-5 w-auto">
                    </div>
                    <div>
                        <p id="headerName" class="text-[10px] font-black uppercase tracking-wider leading-tight">Kurier Log AI</p>
                        <p id="headerSubtitle" class="text-[8px] font-bold opacity-75 uppercase tracking-[0.2em]">DPD Logistics</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-1.5">
                        <!-- Wskaźnik AI Status -->
                        <div id="aiStatusTag" class="inline-flex items-center gap-1 text-[8px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10">
                            <div id="aiDot" class="w-1.5 h-1.5 bg-green-500 rounded-full transition-colors"></div> <span id="aiStatusText">AI: OK</span>
                        </div>
                        <!-- Wskaźnik Blokady -->
                        <div id="wakeStatus" class="inline-flex items-center gap-1 text-[8px] font-bold bg-black/20 px-2 py-1 rounded-full uppercase border border-white/10">
                            <div id="wakeDot" class="w-1.5 h-1.5 bg-red-500 rounded-full transition-colors"></div> <span id="wakeText">Blokada: Wył</span>
                        </div>
                        <div id="currentDate" class="text-[10px] font-bold opacity-90 tracking-wider whitespace-nowrap">--.--.----</div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <button onclick="handleMapToggle()" class="inline-flex items-center gap-2 text-[10px] font-bold bg-white text-dpd-red px-3 py-1.5 h-9 rounded-full uppercase shadow-md active:scale-95 transition-all">
                            <i data-lucide="map" id="toggleIcon" class="w-3.5 h-3.5"></i> <span id="toggleText">Mapa</span>
                        </button>
                        <button onclick="cycleThemeManual()" class="bg-black/20 w-9 h-9 flex flex-col items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                            <i id="themeQuickIcon" data-lucide="sun" class="w-4 h-4 text-white"></i>
                            <span id="themeAutoLabel" class="text-[6px] font-black uppercase mt-0.5 hidden leading-none">Auto</span>
                        </button>
                        <button onclick="toggleView('settings')" class="bg-black/20 w-10 h-10 flex items-center justify-center rounded-full border border-white/10 active:scale-90 shrink-0">
                            <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Nowy układ liczników (oddzielne okienka) -->
            <div class="mt-4 grid grid-cols-3 gap-2">
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[8px] font-black uppercase opacity-70 tracking-tighter text-white mb-0.5">Doręczenia</span>
                    <span id="deliveryCounter" class="text-xl font-black leading-none text-white">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[8px] font-black uppercase opacity-70 tracking-tighter text-white mb-0.5">Odbiory</span>
                    <span id="pickupCounter" class="text-xl font-black leading-none text-zinc-300">0</span>
                </div>
                <div class="glass-card rounded-2xl p-2.5 flex flex-col items-center justify-center text-center">
                    <span class="text-[8px] font-black uppercase opacity-70 tracking-tighter text-white mb-0.5">Napiwki</span>
                    <span id="tipTotal" class="text-xl font-black leading-none text-green-300">0.00 zł</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-gray-100 dark:bg-zinc-900 text-left">
        <!-- Lista Stopów -->
        <div id="listView" class="absolute inset-0 p-4 overflow-y-auto z-1">
            <div id="livePreview" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700/50 rounded-xl text-sm italic text-gray-600 dark:text-yellow-200 hidden min-h-[40px] flex items-center gap-2 shadow-sm">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                </span>
                <span id="liveText" class="break-words">Słucham...</span>
            </div>
            <div id="emptyState" class="text-center py-20 text-gray-400 hidden">
                <i data-lucide="mic" class="w-16 h-16 mx-auto mb-4 opacity-10"></i>
                <p class="font-medium text-sm">Podyktuj adres (np. "Polna 5").</p>
            </div>
            <ul id="addressList" class="space-y-3 pb-64 text-left"></ul>
        </div>

        <!-- Mapa -->
        <div id="mapView" class="absolute inset-0 z-0 view-hidden">
            <div id="map"></div>
        </div>

        <!-- Ustawienia -->
        <div id="settingsView" class="absolute inset-0 z-50 bg-white dark:bg-zinc-950 flex flex-col view-hidden text-left">
            <div class="header-safe-area flex-none"></div>
            <div class="p-4 flex-none">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight">Ustawienia</h2>
                    <button onclick="toggleView('list')" class="p-3 bg-gray-100 dark:bg-zinc-800 rounded-full active:scale-90 transition-all"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="flex bg-gray-100 dark:bg-zinc-900 p-1 rounded-2xl mb-4">
                    <button onclick="switchSettingsTab('config')" id="tabBtnConfig" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all bg-white dark:bg-zinc-800 shadow-sm text-dpd-red">Konfiguracja</button>
                    <button onclick="switchSettingsTab('history')" id="tabBtnHistory" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all text-gray-400">Historia dni</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 pt-0 pb-40">
                <div id="tabContentConfig" class="tab-content active space-y-6">
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1 uppercase">Klucz API Google (Gemma-3-27B)</label>
                        <input type="password" id="setGeminiKey" oninput="applySettings()" placeholder="Wklej klucz API..." class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 text-left">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1 uppercase text-zinc-600 dark:text-zinc-400">Motyw Aplikacji</label>
                        <select id="setTheme" onchange="applySettings()" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 mt-1 cursor-pointer">
                            <option value="light">Jasny</option>
                            <option value="dark">Ciemny</option>
                            <option value="auto">Auto (Wschód/Zachód)</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1 uppercase">Miasto Główne</label>
                        <input type="text" id="setCity" oninput="applySettings()" placeholder="Np. Wrocław" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1 uppercase">Imię Kuriera</label>
                        <input type="text" id="setCourierName" oninput="applySettings()" placeholder="Np. Jan" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1 uppercase">Hasło notatki (fallback)</label>
                        <input type="text" id="setStopWord" oninput="applySettings()" placeholder="notatka" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                    </div>
                    <label class="flex justify-between items-center bg-gray-50 dark:bg-zinc-900/50 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800">
                        <span class="text-sm font-bold">Używaj GPS</span>
                        <input type="checkbox" id="setGpsEnabled" onchange="applySettings()" class="w-5 h-5 accent-dpd-red">
                    </label>
                    <button onclick="confirmAllClear()" class="w-full bg-red-50 dark:bg-red-950/20 text-red-500 p-4 rounded-2xl font-black uppercase text-[10px] border border-red-100 dark:border-red-900/30">Wyczyść całą bazę danych</button>
                </div>
                <div id="tabContentHistory" class="tab-content space-y-4">
                    <div id="historyList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Panele boczne i Modale -->
    <div id="confirmModal" class="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform">
            <i data-lucide="alert-triangle" class="w-10 h-10 text-dpd-red mx-auto mb-4 text-center"></i>
            <h3 class="text-lg font-black uppercase mb-2 text-center">Jesteś pewien?</h3>
            <p id="confirmMessage" class="text-xs text-gray-500 text-center mb-6"></p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-3 rounded-xl font-black uppercase text-[10px] text-center">Nie</button>
                <button id="confirmActionBtn" class="flex-1 bg-dpd-red text-white py-3 rounded-xl font-black uppercase text-[10px] text-center">Tak, usuń</button>
            </div>
        </div>
    </div>

    <div id="tipModal" class="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl scale-95 transition-transform">
            <h3 class="text-lg font-black uppercase mb-1 text-dpd-red">Napiwek</h3>
            <p id="tipAddress" class="text-[10px] text-gray-400 mb-4 font-bold uppercase truncate"></p>
            <input type="number" id="tipInput" placeholder="0.00" step="0.50" inputmode="decimal" class="w-full bg-gray-100 dark:bg-zinc-800 border-none rounded-xl p-4 text-2xl font-black mb-4 focus:ring-2 focus:ring-dpd-red outline-none">
            <div class="flex gap-3 text-left">
                <button onclick="closeTipModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-3 rounded-xl font-black uppercase text-[10px] text-center">Anuluj</button>
                <button onclick="confirmTip()" class="flex-1 bg-dpd-red text-white py-3 rounded-xl font-black uppercase text-[10px] text-center">Zapisz</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity text-left">
        <div class="bg-white dark:bg-zinc-900 w-full max-sm:max-w-xs w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-95 transition-transform">
            <h3 class="text-lg font-black uppercase mb-4 text-dpd-red">Edytuj Stop</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 dark:bg-zinc-900/50 p-3 rounded-xl border border-gray-100 dark:border-zinc-700">
                    <label class="text-[9px] font-bold text-gray-500 block mb-1 uppercase">Adres</label>
                    <input type="text" id="editAddressInput" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0">
                </div>
                <div class="bg-gray-50 dark:bg-zinc-900/50 p-3 rounded-xl border border-gray-100 dark:border-zinc-700">
                    <label class="text-[9px] font-bold text-gray-500 block mb-1 uppercase">Notatka</label>
                    <textarea id="editNoteInput" rows="3" class="w-full bg-transparent border-none text-sm font-bold focus:ring-0 outline-none p-0 resize-none leading-snug"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 bg-gray-100 dark:bg-zinc-800 py-3 rounded-xl font-black uppercase text-[10px] text-center">Anuluj</button>
                <button onclick="confirmEdit()" class="flex-1 bg-dpd-red text-white py-3 rounded-xl font-black uppercase text-[10px] text-center">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Panel Dolny -->
    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 z-30">
        <div class="h-12 bg-gradient-to-t from-gray-100 dark:from-black to-transparent"></div>
        <div class="bg-gray-100 dark:bg-black safe-bottom px-6 pb-6 text-left">
            <div class="max-w-md mx-auto flex justify-around items-center bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl border border-gray-200 dark:border-zinc-800 p-4 relative">
                <button onclick="confirmReset()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-red">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase">Reset</span>
                </button>
                <div class="relative -top-10 text-center">
                    <button id="micBtn" onclick="toggleRecognition()" class="bg-dpd-red text-white w-20 h-20 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all border-4 border-white dark:border-zinc-900">
                        <i data-lucide="mic" id="micIcon" class="w-10 h-10 text-center"></i>
                    </button>
                    <div id="micLabel" class="text-[10px] font-bold text-dpd-red mt-1 opacity-0 transition-opacity uppercase font-black text-center">Słucham...</div>
                </div>
                <button onclick="exportToCSV()" class="flex flex-col items-center gap-1 p-2 text-gray-300 dark:text-zinc-600 active:text-dpd-dark">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase">Raport</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-dpd-dark text-white px-6 py-3 rounded-xl text-sm font-bold shadow-xl opacity-0 transition-all pointer-events-none z-[60] flex items-center gap-2">
        <i id="toastIcon" data-lucide="info" class="w-4 h-4"></i><span id="toastText"></span>
    </div>

    <script>
        const apiKeyPlaceholder = "";
        let addresses = JSON.parse(localStorage.getItem('dpd_logs_v13') || '[]');
        let config = JSON.parse(localStorage.getItem('dpd_config_v12') || JSON.stringify({
            name: "", stopWord: "notatka", theme: "auto", gpsEnabled: true, city: "", geminiKey: ""
        }));

        let isRecording = false, isProcessingAI = false, lastTranscript = "";
        let wakeLock = null, currentView = 'list', map = null, markersGroup = null, cachedGps = null;
        let activeTipId = null, activeEditId = null, confirmCallback = null;
        let sunTimes = null;

        lucide.createIcons();

        // --- UTILS ---
        function setAIStatus(status) {
            const dot = document.getElementById('aiDot');
            const text = document.getElementById('aiStatusText');
            if (status === 'ok') {
                dot.className = "w-1.5 h-1.5 bg-green-500 rounded-full transition-colors";
                text.textContent = "AI: OK";
            } else {
                dot.className = "w-1.5 h-1.5 bg-yellow-500 rounded-full transition-colors";
                text.textContent = "AI: Błąd";
            }
        }

        function showConfirm(msg, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').textContent = msg;
            confirmCallback = () => { onConfirm(); closeConfirm(); };
            document.getElementById('confirmActionBtn').onclick = confirmCallback;
            modal.classList.add('modal-active');
        }
        function closeConfirm() { document.getElementById('confirmModal').classList.remove('modal-active'); confirmCallback = null; }

        async function fetchSunriseSunset(lat, lng) {
            try {
                const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`);
                const data = await res.json();
                if (data.status === "OK") return { sunrise: new Date(data.results.sunrise), sunset: new Date(data.results.sunset) };
            } catch (e) {}
            return null;
        }

        async function refreshTheme() {
            let target = config.theme;
            const autoLabel = document.getElementById('themeAutoLabel');
            if (config.theme === 'auto') {
                const now = new Date();
                if (autoLabel) autoLabel.classList.remove('hidden');
                if (!sunTimes && config.city) {
                    const coords = await geocodeAddress(config.city);
                    if (coords) sunTimes = await fetchSunriseSunset(coords.lat, coords.lng);
                }
                if (sunTimes) target = (now >= sunTimes.sunrise && now < sunTimes.sunset) ? 'light' : 'dark';
                else target = (now.getHours() >= 7 && now.getHours() < 19) ? 'light' : 'dark';
            } else if (autoLabel) autoLabel.classList.add('hidden');

            if (target === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeQuickIcon')?.setAttribute('data-lucide', 'moon');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeQuickIcon')?.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        }

        function cycleThemeManual() {
            const modes = ['light', 'dark', 'auto'];
            config.theme = modes[(modes.indexOf(config.theme) + 1) % 3];
            document.getElementById('setTheme').value = config.theme;
            applySettings();
        }

        // --- GEMMA-3 AI LOGIC (iPhone Ready) ---
        async function parseWithAI(text) {
            const finalKey = config.geminiKey || apiKeyPlaceholder;
            if (!finalKey) { setAIStatus('error'); return null; }
            setUIProcessing(true);
            
            const modelName = "gemma-3-27b";
            const modelUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${finalKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: `Tekst od kuriera: "${text}"` }] }],
                systemInstruction: { 
                    parts: [{ text: "Jesteś asystentem kuriera DPD. Wyodrębnij dane w formacie JSON z polami: address (ulica i numer), note (dodatkowe informacje), type (delivery lub pickup). Jeśli mowa o odbiorze lub paczce do zabrania, ustaw type na pickup. Jeśli brak notatki, pozostaw puste." }] 
                },
                generationConfig: { 
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            address: { type: "STRING" },
                            note: { type: "STRING" },
                            type: { type: "STRING", enum: ["delivery", "pickup"] }
                        },
                        required: ["address", "type"]
                    }
                }
            };

            const backoff = [1000, 2000, 4000, 8000];
            for (let i = 0; i <= backoff.length; i++) {
                try {
                    const res = await fetch(modelUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.json();
                        setUIProcessing(false);
                        setAIStatus('ok');
                        const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        return resultText ? JSON.parse(resultText) : null;
                    }

                    if ((res.status === 429 || res.status >= 500) && i < backoff.length) {
                        await new Promise(r => setTimeout(r, backoff[i]));
                        continue;
                    }
                    throw new Error(`API error: ${res.status}`);
                } catch (e) {
                    if (i === backoff.length) {
                        setUIProcessing(false);
                        setAIStatus('error');
                        return null; 
                    }
                }
            }
            setUIProcessing(false);
            return null;
        }

        function setUIProcessing(proc) {
            isProcessingAI = proc;
            const b = document.getElementById('micBtn');
            const l = document.getElementById('micLabel');
            if (proc) { b?.classList.add('pulse-ai'); if (l) { l.textContent = "Analiza Gemma-3..."; l.style.opacity = '1'; } }
            else { b?.classList.remove('pulse-ai'); if (l) l.style.opacity = '0'; }
        }

        async function handleVoiceResult(text) {
            if (!text || text.trim().length < 2) return;
            
            let aiData = await parseWithAI(text);
            
            if (aiData && aiData.address) {
                addEntry(aiData.address, aiData.note || "", aiData.type || 'delivery');
            } else {
                // Manual Fallback Logic
                let low = text.toLowerCase();
                const kw = (config.stopWord || "notatka").toLowerCase();
                const split = low.indexOf(kw);
                let addr = text, note = "", type = low.includes('odbiór') || low.includes('odebrać') ? 'pickup' : 'delivery';
                if (split !== -1) {
                    addr = text.substring(0, split).trim();
                    note = text.substring(split + kw.length).trim();
                }
                addEntry(formatPolishNumbers(addr), note, type);
            }
        }

        function formatPolishNumbers(text) {
            let t = text.toLowerCase().trim();
            const numMap = { 'zero': '0', 'jeden': '1', 'dwa': '2', 'trzy': '3', 'cztery': '4', 'pięć': '5', 'sześć': '6', 'siedem': '7', 'osiem': '8', 'dziewięć': '9', 'dziesięć': '10' };
            Object.keys(numMap).forEach(w => { t = t.replace(new RegExp(`\\b${w}\\b`, 'g'), numMap[w]); });
            t = t.replace(/(\d+)\s*(przez|na|łamane)\s*(\d+)/g, '$1/$3');
            return t;
        }

        async function geocodeAddress(addr) {
            const searchAddr = addr.split('/')[0].trim();
            let query = encodeURIComponent(searchAddr);
            if (config.city) query += encodeURIComponent(`, ${config.city}`);
            let url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`;
            if (cachedGps) url += `&lat=${cachedGps.lat}&lon=${cachedGps.lng}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data?.[0]) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            } catch (e) {}
            return null;
        }

        async function addEntry(addr, note, type = 'delivery') {
            const entry = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }),
                date: new Date().toLocaleDateString('pl-PL'),
                address: addr.trim().charAt(0).toUpperCase() + addr.trim().slice(1),
                note: note.trim().charAt(0).toUpperCase() + note.trim().slice(1),
                tip: 0, type, lat: null, lng: null
            };
            const coords = await geocodeAddress(entry.address);
            if (coords) { entry.lat = coords.lat; entry.lng = coords.lng; }
            else if (cachedGps) { entry.lat = cachedGps.lat; entry.lng = cachedGps.lng; }
            addresses.unshift(entry);
            saveAndRender();
            showToast("Dodano stop", "check", "text-green-500");
        }

        // --- SPEECH RECOGNITION ---
        const Recog = window.webkitSpeechRecognition || window.SpeechRecognition;
        if (Recog) {
            const recog = new Recog();
            recog.lang = 'pl-PL'; recog.interimResults = true; recog.continuous = false;
            recog.onstart = () => {
                isRecording = true; lastTranscript = "";
                document.getElementById('micBtn')?.classList.add('pulse-red');
                document.getElementById('livePreview')?.classList.remove('hidden');
                document.getElementById('micLabel')?.classList.add('opacity-100');
                requestWakeLock(); prefetchGps();
            };
            recog.onresult = (e) => {
                let inter = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) lastTranscript = e.results[i][0].transcript;
                    else inter += e.results[i][0].transcript;
                }
                document.getElementById('liveText').textContent = inter || lastTranscript || "Słucham...";
            };
            recog.onend = () => {
                isRecording = false;
                document.getElementById('micBtn')?.classList.remove('pulse-red');
                document.getElementById('livePreview')?.classList.add('hidden');
                document.getElementById('micLabel')?.classList.remove('opacity-100');
                if (lastTranscript && lastTranscript.length > 2) handleVoiceResult(lastTranscript);
                lastTranscript = "";
            };
            window.toggleRecognition = () => { if (!isProcessingAI) isRecording ? recog.stop() : recog.start(); };
        }

        // --- RENDER & NAVIGATION ---
        function saveAndRender() {
            localStorage.setItem('dpd_logs_v13', JSON.stringify(addresses));
            const today = new Date().toLocaleDateString('pl-PL');
            const todayLogs = addresses.filter(a => a.date === today);
            document.getElementById('deliveryCounter').textContent = todayLogs.filter(a => a.type === 'delivery').length;
            document.getElementById('pickupCounter').textContent = todayLogs.filter(a => a.type === 'pickup').length;
            document.getElementById('tipTotal').textContent = todayLogs.reduce((s, c) => s + (parseFloat(c.tip) || 0), 0).toFixed(2) + " zł";
            document.getElementById('headerName').textContent = config.name ? `Kurier: ${config.name}` : "Kurier Log AI";

            const listEl = document.getElementById('addressList');
            if (todayLogs.length === 0) {
                listEl.innerHTML = ''; document.getElementById('emptyState')?.classList.remove('hidden');
            } else {
                document.getElementById('emptyState')?.classList.add('hidden');
                listEl.innerHTML = todayLogs.map(item => `
                    <li class="bg-white dark:bg-zinc-800 p-4 rounded-2xl shadow-sm border-l-4 ${item.type === 'pickup' ? 'border-l-zinc-500' : 'border-l-dpd-red'} border border-gray-100 dark:border-zinc-700 text-left">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <span class="text-[8px] font-black uppercase opacity-60">${item.type === 'pickup' ? 'Odbiór' : 'Doręczenie'} ${item.time}</span>
                                <p class="text-dpd-dark dark:text-gray-100 font-bold text-sm mt-1 leading-tight">${item.address}</p>
                            </div>
                            <div class="flex gap-1 shrink-0">
                                <button onclick="toggleType(${item.id})" class="text-zinc-400 dark:text-zinc-500 p-1"><i data-lucide="${item.type === 'pickup' ? 'package-plus' : 'truck'}" class="w-4 h-4"></i></button>
                                <button onclick="openEditModal(${item.id})" class="text-zinc-400 dark:text-zinc-500 p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="openTipModal(${item.id})" class="text-zinc-400 dark:text-zinc-500 p-1 ${item.tip > 0 ? 'text-green-500' : ''}"><i data-lucide="banknote" class="w-4 h-4"></i></button>
                                <button onclick="deleteAddress(${item.id})" class="text-zinc-400 dark:text-zinc-500 p-1 hover:text-dpd-red"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        ${item.note ? `<div class="mt-2 text-[11px] text-gray-500 italic border-t border-gray-50 dark:border-zinc-700 pt-1">${item.note}</div>` : ''}
                    </li>`).join('');
            }
            lucide.createIcons();
            if (map && currentView === 'map') renderMarkers();
        }

        function switchSettingsTab(tab) {
            const isConfig = tab === 'config';
            document.getElementById('tabBtnConfig').className = isConfig ? 'flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all bg-white dark:bg-zinc-800 shadow-sm text-dpd-red' : 'flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all text-gray-400';
            document.getElementById('tabBtnHistory').className = !isConfig ? 'flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all bg-white dark:bg-zinc-800 shadow-sm text-dpd-red' : 'flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all text-gray-400';
            document.getElementById('tabContentConfig').classList.toggle('active', isConfig);
            document.getElementById('tabContentHistory').classList.toggle('active', !isConfig);
            if (!isConfig) renderGroupedHistory();
            lucide.createIcons();
        }

        function renderGroupedHistory() {
            const list = document.getElementById('historyList');
            if (!list || !addresses.length) return;
            const grouped = addresses.reduce((acc, curr) => {
                if (!acc[curr.date]) acc[curr.date] = { date: curr.date, stops: [] };
                acc[curr.date].stops.push(curr);
                return acc;
            }, {});
            const sorted = Object.keys(grouped).sort((a,b) => {
                const partsA = a.split('.'), partsB = b.split('.');
                return new Date(partsB[2], partsB[1]-1, partsB[0]) - new Date(partsA[2], partsA[1]-1, partsA[0]);
            });
            list.innerHTML = sorted.map(k => {
                const day = grouped[k];
                const tips = day.stops.reduce((s, c) => s + (parseFloat(c.tip) || 0), 0).toFixed(2);
                return `
                <div class="bg-gray-50 dark:bg-zinc-900/50 rounded-2xl border border-gray-100 dark:border-zinc-800 overflow-hidden mb-4 text-left text-left">
                    <div class="p-4 flex justify-between items-center bg-white/50 dark:bg-black/20 text-left">
                        <div class="text-left">
                            <p class="text-[11px] font-black uppercase text-dpd-red leading-none text-left">${day.date}</p>
                            <p class="text-[8px] font-bold opacity-40 uppercase mt-1 text-left">Napiwki: ${tips} zł</p>
                        </div>
                        <div class="flex gap-1 text-left">
                            <button onclick="exportSpecificDay('${day.date}')" class="p-2 text-gray-400 text-left"><i data-lucide="download" class="w-4 h-4 text-left text-left"></i></button>
                            <button onclick="this.parentElement.parentElement.nextElementSibling.classList.toggle('hidden')" class="p-2 text-gray-400 text-left"><i data-lucide="chevron-down" class="w-4 h-4 text-left text-left"></i></button>
                        </div>
                    </div>
                    <div class="hidden p-4 space-y-2 border-t border-gray-100 dark:border-zinc-800 text-left text-left">
                        ${day.stops.map(s => `<div class="flex justify-between text-[10px] text-left"><span>${s.time}</span><span class="flex-1 px-3 truncate opacity-80 text-left">${s.address}</span><span class="font-black ${s.type === 'pickup' ? 'text-zinc-400' : 'text-dpd-red'} text-left text-left">${s.type === 'pickup' ? 'O' : 'D'}</span></div>`).join('')}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function exportSpecificDay(date) {
            const data = addresses.filter(a => a.date === date); if (!data.length) return;
            let csv = "\uFEFFData;Godzina;Typ;Adres;Notatka;Napiwek;Szerokość;Długość\n" + data.map(r => `${r.date};${r.time};${r.type};"${r.address}";"${r.note}";${r.tip};${r.lat || ''};${r.lng || ''}`).join("\n");
            const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(b); link.download = `Raport_${date.replace(/\./g, '_')}.csv`; link.click();
        }

        function applySettings() {
            config.theme = document.getElementById('setTheme').value;
            config.city = document.getElementById('setCity').value;
            config.name = document.getElementById('setCourierName').value;
            config.stopWord = document.getElementById('setStopWord').value || "notatka";
            config.gpsEnabled = document.getElementById('setGpsEnabled').checked;
            config.geminiKey = document.getElementById('setGeminiKey').value;
            localStorage.setItem('dpd_config_v12', JSON.stringify(config));
            sunTimes = null; refreshTheme(); saveAndRender();
        }

        function toggleView(v) {
            const vs = { list: 'listView', map: 'mapView', settings: 'settingsView' };
            Object.values(vs).forEach(id => document.getElementById(id)?.classList.add('view-hidden'));
            document.getElementById(vs[v])?.classList.remove('view-hidden');
            currentView = v;
            const tIcon = document.getElementById('toggleIcon'), tText = document.getElementById('toggleText');
            if (v === 'map') {
                tIcon?.setAttribute('data-lucide', 'list'); if (tText) tText.textContent = 'Lista';
                initMap(); setTimeout(() => { map?.invalidateSize(); renderMarkers(); }, 200);
            } else {
                tIcon?.setAttribute('data-lucide', 'map'); if (tText) tText.textContent = 'Mapa';
            }
            lucide.createIcons();
        }
        function handleMapToggle() { currentView === 'map' ? toggleView('list') : toggleView('map'); }

        // --- LEAFLET MAP & CLUSTERING ---
        function initMap() { 
            if (!map) { 
                map = L.map('map', { zoomControl: false }).setView([52.23, 21.01], 13); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
                markersGroup = L.layerGroup().addTo(map); 
            } 
        }
        function renderMarkers() {
            if (!markersGroup) return; 
            markersGroup.clearLayers(); 
            const today = new Date().toLocaleDateString('pl-PL'); 
            const pts = addresses.filter(a => a.date === today && a.lat);
            if (!pts.length) return; 
            const grouped = pts.reduce((acc, p) => {
                const key = `${p.lat.toFixed(5)}_${p.lng.toFixed(5)}`;
                if (!acc[key]) acc[key] = []; acc[key].push(p); return acc;
            }, {});
            const bounds = L.latLngBounds();
            Object.entries(grouped).forEach(([key, items]) => {
                const [lat, lng] = key.split('_').map(Number);
                const count = items.length;
                const icon = L.divIcon({
                    html: `<div class="relative"><i data-lucide="map-pin" class="w-8 h-8 text-dpd-red drop-shadow-md text-left text-left"></i>${count > 1 ? `<div class="absolute -top-1 -right-1 marker-cluster-custom w-5 h-5 text-center text-left text-left">${count}</div>` : ''}</div>`,
                    className: 'custom-div-icon', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
                });
                const popup = `<div class="p-3 text-left"><p class="text-[10px] font-black uppercase text-dpd-red mb-2 border-b pb-1 text-left">Punkty (${count})</p><ul class="space-y-2 max-h-48 overflow-y-auto text-left text-left">${items.map(it => `<li class="text-[11px] text-left text-left"><b>${it.time}</b> ${it.address}</li>`).join('')}</ul></div>`;
                L.marker([lat, lng], { icon }).bindPopup(popup).addTo(markersGroup);
                bounds.extend([lat, lng]);
            });
            map.fitBounds(bounds, { padding: [50, 50] }); lucide.createIcons();
        }

        // --- ACTIONS & MODALS ---
        function deleteAddress(id) { showConfirm("Usunąć ten stop?", () => { addresses = addresses.filter(a => a.id != id); saveAndRender(); }); }
        function confirmReset() { showConfirm("Wyczyścić dzisiejsze stopy?", () => { const today = new Date().toLocaleDateString('pl-PL'); addresses = addresses.filter(a => a.date !== today); saveAndRender(); }); }
        function confirmAllClear() { showConfirm("Usunąć całą historię?", () => { addresses = []; saveAndRender(); }); }
        function toggleType(id) { const idx = addresses.findIndex(a => a.id === id); if (idx !== -1) { addresses[idx].type = addresses[idx].type === 'delivery' ? 'pickup' : 'delivery'; saveAndRender(); } }
        function openEditModal(id) { activeEditId = id; const it = addresses.find(a => a.id === id); if (it) { document.getElementById('editAddressInput').value = it.address; document.getElementById('editNoteInput').value = it.note; document.getElementById('editModal').classList.add('modal-active'); } }
        function confirmEdit() { const idx = addresses.findIndex(a => a.id === activeEditId); if (idx !== -1) { addresses[idx].address = document.getElementById('editAddressInput').value; addresses[idx].note = document.getElementById('editNoteInput').value; saveAndRender(); } closeEditModal(); }
        function closeEditModal() { document.getElementById('editModal').classList.remove('modal-active'); }
        function openTipModal(id) { activeTipId = id; const it = addresses.find(a => a.id === id); if (it) { document.getElementById('tipAddress').textContent = it.address; document.getElementById('tipInput').value = it.tip || ""; document.getElementById('tipModal').classList.add('modal-active'); } }
        function confirmTip() { const val = parseFloat(document.getElementById('tipInput').value) || 0; const idx = addresses.findIndex(a => a.id === activeTipId); if (idx !== -1) { addresses[idx].tip = val; saveAndRender(); } closeTipModal(); }
        function closeTipModal() { document.getElementById('tipModal').classList.remove('modal-active'); }

        function showToast(m, i, c) {
            const t = document.getElementById('toast');
            document.getElementById('toastText').textContent = m;
            const icon = document.getElementById('toastIcon');
            icon.setAttribute('data-lucide', i);
            icon.className = `w-4 h-4 ${c}`;
            lucide.createIcons(); t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3000);
        }
        function prefetchGps() { if (navigator.geolocation && config.gpsEnabled) navigator.geolocation.getCurrentPosition(p => cachedGps = { lat: p.coords.latitude, lng: p.coords.longitude }, null, { enableHighAccuracy: true }); }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); const d = document.getElementById('wakeDot'); if (d) d.className = "w-1.5 h-1.5 bg-green-500 rounded-full"; document.getElementById('wakeText').textContent = "Blokada: WŁ"; } } catch(e){} }
        function exportToCSV() { const today = new Date().toLocaleDateString('pl-PL'); exportSpecificDay(today); }

        // --- INIT ---
        document.getElementById('setCity').value = config.city || "";
        document.getElementById('setTheme').value = config.theme || "auto";
        document.getElementById('setCourierName').value = config.name || "";
        document.getElementById('setStopWord').value = config.stopWord || "notatka";
        document.getElementById('setGpsEnabled').checked = config.gpsEnabled !== false;
        document.getElementById('setGeminiKey').value = config.geminiKey || "";
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pl-PL');
        
        refreshTheme(); 
        saveAndRender();
        setInterval(refreshTheme, 60000);
        document.body.addEventListener('click', () => { if (!wakeLock) requestWakeLock(); }, { once: true });
    </script>
</body>
</html>